<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1">
<title>Магазин с корзиной и избранным</title>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  /* --- твои стили (сохранены) --- */
  #content { transition: transform 0.1s ease; }
  .content-left { transform: translateX(200px); opacity: 0; }
  .content-right { transform: translateX(-200px); opacity: 0; }
  .content-active { opacity: 1; }
  #content h2 { margin-top: 60px; /* чуть больше, чем высота верхнего меню */ }
  .search-box { display: inline-flex; align-items: center; position: relative; transition: width 0.3s ease; overflow: hidden; vertical-align: middle; width: 40px; }
  .search-box.active { width: 200px; }
  .search-box input { border: 1px solid #ccc; border-radius: 30px; padding: 5px 10px; font-size: 14px; width: 100%; opacity: 0; transition: opacity 0.3s ease; }
  .search-box.active input { opacity: 1; }
  body { margin:0; font-family:Arial,sans-serif; scroll-behavior:smooth; }
  .top-nav { position:fixed; top:0; left:0; right:0; background:white; z-index:9998; padding:2px; white-space:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch; overflow-anchor: none; }
  .top-nav a {display:inline-block;padding:14px 16px;text-decoration:none;color:black;}
  .top-nav a.active {border:1px solid maroon;border-radius:30px;color:maroon;font-weight:600;}
  .count-badge {background:maroon;color:white;border-radius:50%;padding:2px 7px;font-size:12px;margin-left:5px;vertical-align:middle;font-weight:600;}
  .category-nav {position:fixed;bottom:0;left:0;right:0;background:white;overflow-x:auto;white-space:nowrap;border-top:1px solid #ccc;z-index: 1;}
  .category-nav a {display:inline-block;padding:14px 16px;text-decoration:none;color:black;transition:0.3s;}
  .category-nav a.active {background:maroon;color:white;border-radius:30px;font-weight:600;}
  .content {padding:60px 0 60px 0;}
  .section {padding:20px;margin-bottom:40px;border-bottom:1px solid #ccc;}
  .w3-modal-content {position:fixed;bottom:0;left:0;right:0;max-width:700px;margin:auto;}
  .square-image {width:100%;height:300px;overflow:hidden;}
  .square-image img {width:100%;height:100%;object-fit:cover;}
  .like-container {cursor:pointer;display:flex;align-items:center;gap:4px;}
  .like-btn {color:red;font-size:20px;}
  .fixed-buy {position:fixed;left:0;right:0;bottom:0;background:#fff;box-shadow:0 -2px 6px rgba(0,0,0,.1);padding:10px 16px;z-index:9997;}
  .fixed-buy .sum {font-weight:700;margin:0 0 8px;}
  /* небольшой стиль для списка товаров в модалке сета */
  .set-item-row {display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;}
  .set-item-row .left {display:flex;gap:10px;align-items:center;}
  .set-item-row img {width:64px;height:64px;object-fit:cover;border-radius:6px;}
  .qty-controls button {min-width:36px;}
</style>
</head>
<body>

<!-- Верхнее меню -->
<div id="topNav" class="top-nav">
  <div id="searchBox" class="search-box">
    <i id="searchIcon" class="fa fa-search" style="cursor:pointer;padding:14px 10px;"></i>
    <input type="text" id="searchInput" placeholder="Поиск...">
  </div>

  <!-- порядок ссылок: меню, избранное, корзина, наборы -->
  <a href="#menu" class="active" data-role="menu">Меню</a>
  <a href="#favorites" data-role="favorites">Избранное 
    <span id="favCount" class="count-badge" style="display:none"></span>
  </a>
  <a href="#cart" data-role="cart">Корзина 
    <span id="cartCount" class="count-badge" style="display:none"></span>
  </a>
  <a href="#sets" data-role="sets" id="topSetsLink">Наборы</a>
</div>

<!-- Нижнее меню категорий -->
<div id="categoryNav" class="category-nav"></div>

<!-- Контент -->
<div class="content" id="content"></div>

<!-- Модальное окно товара (без изменений, используется для одиночных товаров) -->
<div id="productModal" class="w3-modal">
  <div class="w3-modal-content w3-animate-bottom">
    <header class="square-image">
      <span onclick="closeModal()" class="w3-button w3-display-topright">&times;</span>
      <img id="modalImage" src="" alt="">
    </header>
    <div class="w3-container" style="padding-bottom:20px;">
      <h3 id="modalName"></h3>
      <div style="display:flex;justify-content:space-between;">
        <p id="modalPrice"></p><p id="modalWeight"></p>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-top:15px;">
        <div>
          <button id="qtyMinus" class="w3-button w3-black w3-round">-</button>
          <span id="qtyValue">1</span>
          <button id="qtyPlus" class="w3-button w3-black w3-round">+</button>
        </div>
        <p id="totalPrice" style="font-weight:bold;">0 грн</p>
        <button class="w3-button w3-green" onclick="addToCart()">В корзину</button>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно набора -->
<div id="setModal" class="w3-modal">
  <div class="w3-modal-content w3-animate-bottom">
    <header class="square-image">
      <span onclick="closeSetModal()" class="w3-button w3-display-topright">&times;</span>
      <img id="setModalImage" src="" alt="">
    </header>
    <div class="w3-container" style="padding-bottom:10px;">
      <h3 id="setModalName"></h3>
      <p id="setModalDesc" class="w3-small w3-text-grey"></p>

      <div id="setItemsList"></div>

      <div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px;">
        <div>
          <button id="setQtyMinus" class="w3-button w3-black w3-round">-</button>
          <span id="setQtyValue">1</span>
          <button id="setQtyPlus" class="w3-button w3-black w3-round">+</button>
        </div>
        <p id="setTotalPrice" style="font-weight:bold;">0 грн</p>
        <button class="w3-button w3-green" id="addSetToCartBtn">В корзину</button>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно оформления заказа (без изменений) -->
<div id="orderModal" class="w3-modal">
  <div class="w3-modal-content w3-animate-bottom">
    <header class="w3-container w3-teal">
      <span onclick="document.getElementById('orderModal').style.display='none'" class="w3-button w3-display-topright">&times;</span>
      <h3>Оформление заказа</h3>
    </header>
    <div class="w3-container" style="padding-bottom:20px;">
      <form id="orderForm" method="post" action="order.php">
        <p>Сумма заказа: <strong id="orderTotal"></strong> грн</p>
        <input type="hidden" name="total" id="formTotal">
        <p><input class="w3-input" type="text" name="name" placeholder="Ваше имя" required></p>
        <p><input class="w3-input" type="tel" name="phone" placeholder="Телефон" required></p>
        <p>
          <select class="w3-select" name="delivery" required>
            <option value="" disabled selected>Выберите доставку</option>
            <option value="Самовывоз">Самовывоз</option>
            <option value="Адресная доставка">Адресная доставка</option>
          </select>
        </p>
        <p><textarea class="w3-input" name="comment" placeholder="Комментарий к заказу"></textarea></p>
        <input type="hidden" name="cart" id="formCart">
        <button class="w3-button w3-green" type="submit" style="width:100%">Отправить заказ</button>
      </form>
    </div>
  </div>
</div>

<script>
/* ========= Глобальные переменные ========= */
let startX = 0, startY = 0;
let currentIndex = 1; // 0: search, 1: menu, 2: favorites, 3: cart
const tabs = ["search", "menu", "favorites", "cart"];
let isFromCategoryNav = false;
let isFromTopNav = false;

let menuData = null, cardTemplate = '', sections = [], navLinks = [];
let favorites = new Set(), cart = [], currentProduct = null, quantity = 1;

/* ====== Модалки и временные данные для сетов ====== */
let currentSet = null; // объект сета при открытой модалке
let setModalItems = []; // [{ productId, qty, step, productData }]
let setModalQty = 1;

/* ========= Загрузка состояния/данных ========= */
function loadState() {
  try { favorites = new Set(JSON.parse(localStorage.getItem("favorites") || "[]")); } catch { favorites = new Set(); }
  try { cart = JSON.parse(localStorage.getItem("cart") || "[]"); } catch { cart = []; }
}
function saveState() {
  localStorage.setItem("favorites", JSON.stringify([...favorites]));
  localStorage.setItem("cart", JSON.stringify(cart));
}

/* ========= Utility ========= */
function formatPrice(v){ return Number(v||0) + " грн"; }
function findProductById(id){ return menuData.menu.find(x => String(x.id) === String(id)); }

/* ========= Обработчики свайпов (не менял) ========= */
document.addEventListener("touchstart", e => {
  startX = e.touches[0].clientX;
  startY = e.touches[0].clientY;
  isFromCategoryNav = e.target.closest("#categoryNav") !== null;
  isFromTopNav = e.target.closest("#topNav") !== null;
});
document.addEventListener("touchend", e => {
  try {
    if (isFromCategoryNav || isFromTopNav) return;
    const dx = e.changedTouches[0].clientX - startX;
    const dy = e.changedTouches[0].clientY - startY;
    if (Math.abs(dx) < 50 || Math.abs(dx) < Math.abs(dy)) return;
    e.preventDefault();
    if (dx < 0) activateTab(currentIndex + 1, "left");
    else activateTab(currentIndex - 1, "right");
  } catch(err) { console.error(err); }
});

/* ========= Прокрутка верхнего меню к активному ========= */
function scrollTopNavToActive() {
  const bar = document.getElementById('topNav');
  const active = bar.querySelector('a.active');
  if (!active) return;
  const searchBox = document.getElementById('searchBox');
  const searchWidth = searchBox.offsetWidth || 0;
  const left = active.offsetLeft;
  const right = left + active.offsetWidth;
  const viewLeft = bar.scrollLeft;
  const viewRight = viewLeft + bar.clientWidth;
  const targetLeft = active.textContent.includes('Меню') ? (left - searchWidth) : left;
  if (targetLeft < viewLeft) bar.scrollTo({ left: targetLeft, behavior: 'smooth' });
  else if (right > viewRight) bar.scrollTo({ left: right - bar.clientWidth, behavior: 'smooth' });
}

/* ========= Активация вкладки (как было) ========= */
function activateTab(index, direction = "left") {
  if (index < 0 || index >= tabs.length) return;
  currentIndex = index;
  const searchBox = document.getElementById("searchBox");
  const searchInput = document.getElementById("searchInput");
  const topNav = document.getElementById("topNav");
  let savedScroll = topNav.scrollLeft;
  if (searchBox.classList.contains("active") && index !== 0) {
    searchInput.blur();
    searchBox.classList.remove("active");
    searchInput.value = "";
    setTimeout(() => {
      topNav.scrollLeft = savedScroll;
      scrollTopNavToActive();
    }, 310);
  }
  const content = document.getElementById("content");
  content.className = direction === "left" ? "content-left" : "content-right";
  setTimeout(() => {
    const t = tabs[index];
    if (t === "search") {
      showMenu();
      searchBox.classList.add("active");
      setTimeout(() => searchInput.focus(), 200);
    }
    if (t === "menu") showMenu();
    if (t === "favorites") showFavorites();
    if (t === "cart") showCart();
    content.className = "content-active";
    if (t !== "search") scrollTopNavToActive();
  }, 200);
}

/* ========= Счётчики ========= */
function updateFavCount() {
  const el = document.getElementById("favCount");
  if (favorites.size) { el.style.display = "inline-block"; el.textContent = favorites.size; }
  else el.style.display = "none";
  requestAnimationFrame(scrollTopNavToActive);
}
function updateCartCount() {
  const el = document.getElementById("cartCount");
  if (cart.length) { el.style.display = "inline-block"; el.textContent = cart.length; }
  else el.style.display = "none";
  requestAnimationFrame(scrollTopNavToActive);
}

/* ========= Рендер карточки товара (оригинальная, слегка упрощена) ========= */
function renderCard(item) {
  // item — товар из menuData.menu
  const baseVotes = Number(item.vote || 0);
  let html = cardTemplate
    .replace(/{IMAGE}/g, item.images || '')
    .replace(/{NAME}/g, item.name || '')
    .replace(/{PRICE}/g, item.price || '')
    .replace(/{WEIGHT}/g, item.weight || '')
    .replace(/{VOTE}/g, baseVotes);

  const wrap = document.createElement("div");
  wrap.innerHTML = html;
  const card = wrap.firstElementChild;

  const like = card.querySelector(".like-btn");
  const voteEl = card.querySelector(".vote-count");

  const setVoteUI = () => { if (voteEl) voteEl.textContent = String(baseVotes + (favorites.has(item.id) ? 1 : 0)); };
  like.classList.toggle("fas", favorites.has(item.id));
  like.classList.toggle("far", !favorites.has(item.id));
  setVoteUI();

  like.addEventListener("click", (e) => {
    e.stopPropagation();
    if (favorites.has(item.id)) favorites.delete(item.id); else favorites.add(item.id);
    saveState(); updateFavCount();
    like.classList.toggle("fas"); like.classList.toggle("far"); setVoteUI();
  });

  card.addEventListener("click", () => {
    openModal({
      id: item.id,
      name: item.name,
      price: +item.price,
      weight: item.weight,
      image: "images/" + item.images
    });
  });

  return card;
}

/* ========= Рендер карточки сета — использует тот же шаблон card.html, но меняет обработчики ========= */
function renderSetCard(set) {
  // Используем cardTemplate, подставляем поля набора (images, name, price, weight)
  let html = cardTemplate
    .replace(/{IMAGE}/g, set.images || '')
    .replace(/{NAME}/g, set.name || '')
    .replace(/{PRICE}/g, set.price || '')
    .replace(/{WEIGHT}/g, set.weight || '')
    .replace(/{VOTE}/g, 0);

  const wrap = document.createElement("div");
  wrap.innerHTML = html;
  const card = wrap.firstElementChild;

  const like = card.querySelector(".like-btn");
  const voteEl = card.querySelector(".vote-count");

  const setVoteUI = () => { if (voteEl) voteEl.textContent = String(0 + (favorites.has(set.id) ? 1 : 0)); };
  like.classList.toggle("fas", favorites.has(set.id));
  like.classList.toggle("far", !favorites.has(set.id));
  setVoteUI();

  like.addEventListener("click", (e) => {
    e.stopPropagation();
    if (favorites.has(set.id)) favorites.delete(set.id); else favorites.add(set.id);
    saveState(); updateFavCount();
    like.classList.toggle("fas"); like.classList.toggle("far"); setVoteUI();
    // если сейчас мы в разделе избранного — обновить
    if (currentIndex === 2) showFavorites();
  });

  // клик по карточке — открыть модалку сета
  card.addEventListener("click", () => openSetModal(set.id));

  return card;
}

/* ========= Построение нижней навигации категорий (товары) ========= */
function buildMenuNav(cats) {
  const nav = document.getElementById("categoryNav"); nav.innerHTML = '';
  cats.forEach(cat => {
    const a = document.createElement("a"); a.href = "#" + cat.id; a.textContent = cat.name;
    // при клике просто плавно прокручиваем к секции (как раньше) — без перебивания
    a.addEventListener('click', (ev) => { /* оставляем дефолт поведение для якорей */ });
    nav.appendChild(a);
  });
  navLinks = nav.querySelectorAll("a");
}

/* ========= Построение каталога (товары) ========= */
function buildCatalog(cats, items) {
  const content = document.getElementById("content"); content.innerHTML = '';
  document.getElementById("categoryNav").style.display = "block";
  cats.forEach(cat => {
    const sec = document.createElement("section"); sec.className = "section"; sec.id = cat.id;
    sec.innerHTML = "<h2>" + cat.name + "</h2>";
    items.filter(i => i.category === cat.id).forEach(item => {
      sec.appendChild(renderCard(item));
    });
    content.appendChild(sec);
  });
  sections = document.querySelectorAll(".section");
  observeSections();
}

function showMenu() { clearFixedBuy(); buildCatalog(menuData.categories, menuData.menu); }

/* ========= Поиск (без изменений) ========= */
const searchInput = document.getElementById("searchInput");
searchInput.addEventListener("input", () => {
  const query = searchInput.value.toLowerCase();
  if (!query) { showMenu(); return; }
  clearFixedBuy();
  const content = document.getElementById("content");
  content.innerHTML = '<h2 style="margin-top:70px">Результаты поиска</h2>';
  document.getElementById("categoryNav").style.display = "none";
  const matches = menuData.menu.filter(i => i.name.toLowerCase().includes(query));
  if (!matches.length) { content.innerHTML += "<p>Ничего не найдено</p>"; return; }
  matches.forEach(item => content.appendChild(renderCard(item)));
});

/* ========= Избранное — расширено: включает товары и сеты ========= */
function showFavorites() {
  clearFixedBuy();
  const content = document.getElementById("content");
  content.classList.remove("content-left", "content-right");
  content.innerHTML = '<h2 style="margin-top:70px">Избранное</h2>';
  document.getElementById("categoryNav").style.display = "none";

  // продукты
  const favProducts = menuData.menu.filter(i => favorites.has(i.id));
  // сеты (если favorites содержит id сета)
  const favSets = (menuData.sets || []).filter(s => favorites.has(s.id));

  if (!favProducts.length && !favSets.length) { content.innerHTML += "<p>Пусто</p>"; return; }

  favSets.forEach(s => content.appendChild(renderSetCard(s)));
  favProducts.forEach(p => content.appendChild(renderCard(p)));
  setTimeout(scrollTopNavToActive,150);
}

/* ========= Корзина — поддерживает продукты и сеты ========= */
function showCart() {
  const content = document.getElementById("content");
  content.classList.remove("content-left", "content-right");
  content.innerHTML = '<h2 style="margin-top:70px">Корзина</h2>';
  document.getElementById("categoryNav").style.display = "none";
  clearFixedBuy();

  if (!cart.length) { content.innerHTML += "<p>Пусто</p>"; return; }

  let total = 0;
  cart.forEach(item => {
    // Если это набор — у него поле type === 'set' or item.items exists
    if (item.type === 'set' || item.items) {
      // отображаем набор
      const div = document.createElement("div"); div.className = "w3-row basket w3-padding";
      let inner = `<div class="w3-col" style="width:60%"><strong>${item.name}</strong><br><div class="w3-small w3-text-grey">Сет</div>`;
      // перечислим входящие товары (получим детали из menuData)
      inner += '<div class="w3-margin-top">';
      item.items.forEach(si => {
        const prod = findProductById(si.id);
        const qty = (si.qty || si.quantity || 1) * (item.quantity || 1);
        inner += `<div class="w3-small">${prod ? prod.name : si.id} — ${qty} ${prod && prod.unit ? prod.unit : ''} (${prod ? prod.price : si.price} грн)</div>`;
      });
      inner += '</div></div>';

      // правая колонка — картинка и управление количеством набора
      inner += `<div class="w3-col w3-padding w3-center" style="width:40%"><img src="images/${item.image || ''}" style="width:100%;max-width:200px;"><div class="w3-padding">`;
      inner += `<button class="w3-btn w3-round-xxlarge w3-black" onclick="decQty('${item.id}')">${item.quantity === 1 ? '<i class="fa fa-trash"></i>' : '-'}</button>`;
      inner += `<strong> ${item.quantity} </strong>`;
      inner += `<button class="w3-btn w3-round-xxlarge w3-black" onclick="incQty('${item.id}')">+</button>`;
      inner += `</div></div>`;

      div.innerHTML = inner;
      content.appendChild(div);

      total += (Number(item.price) * (item.quantity || 1));
    } else {
      // обычный товар — как было
      total += item.price * item.quantity;
      const div = document.createElement("div"); div.className = "w3-row basket w3-padding";
      div.innerHTML = `
        <div class="w3-col" style="width:50%">
          <strong>${item.name}</strong><br>
          <div class="w3-small w3-text-grey">${item.price} грн | ${item.weight || ''}</div>
          <strong>${item.price * item.quantity} грн</strong>
        </div>
        <div class="w3-col w3-padding w3-center" style="width:50%">
          <img src="${item.image}" style="width:100%;max-width:200px;">
          <div class="w3-padding">
            <button class="w3-btn w3-round-xxlarge w3-black" onclick="decQty('${item.id}')">
              ${item.quantity === 1 ? '<i class="fa fa-trash"></i>' : '-'}
            </button>
            <strong> ${item.quantity} </strong>
            <button class="w3-btn w3-round-xxlarge w3-black" onclick="incQty('${item.id}')">+</button>
          </div>
        </div>`;
      content.appendChild(div);
    }
  });

  const bar = document.createElement('div'); bar.className = 'fixed-buy';
  bar.innerHTML = `
    <p class="sum">Итого: ${total} грн</p>
    <button class="w3-button w3-green w3-round-xxlarge" style="width:100%" onclick="openOrderForm(${total})">Купить</button>
  `;
  document.body.appendChild(bar);
  setTimeout(scrollTopNavToActive,150);
}

function clearFixedBuy() { const old = document.querySelector('.fixed-buy'); if (old) old.remove(); }
function incQty(id) {
  const it = cart.find(i => i.id === id);
  if (it) { it.quantity = (it.quantity||0) + 1; saveState(); showCart(); updateCartCount(); }
}
function decQty(id) {
  const i = cart.findIndex(it => it.id === id);
  if (i > -1) {
    if (cart[i].quantity > 1) cart[i].quantity--; else cart.splice(i,1);
  }
  saveState(); showCart(); updateCartCount();
}

/* ========= Модалка товара (без изменений) ========= */
function openModal(p) {
  currentProduct = p; quantity = 1;
  document.getElementById("modalName").textContent = p.name;
  document.getElementById("modalPrice").textContent = p.price + " грн";
  document.getElementById("modalWeight").textContent = p.weight || '';
  document.getElementById("modalImage").src = p.image;
  document.getElementById("qtyValue").textContent = 1;
  document.getElementById("totalPrice").textContent = p.price + " грн";
  document.getElementById("productModal").style.display = "block";
}
function closeModal() { document.getElementById("productModal").style.display = "none"; }
document.getElementById("qtyPlus").onclick = () => { quantity++; document.getElementById("qtyValue").textContent = quantity; updateTotal(); }
document.getElementById("qtyMinus").onclick = () => { if (quantity > 1) { quantity--; document.getElementById("qtyValue").textContent = quantity; updateTotal(); } }
function updateTotal() { document.getElementById("totalPrice").textContent = (currentProduct.price * quantity) + " грн"; }
function addToCart() {
  if (!currentProduct) return;
  let ex = cart.find(i => i.id === currentProduct.id && !i.type);
  if (ex) ex.quantity += quantity; else cart.push({ ...currentProduct, quantity, image: currentProduct.image });
  saveState(); updateCartCount(); closeModal();
}
window.onclick = e => {
  if (e.target == document.getElementById("productModal")) closeModal();
  if (e.target == document.getElementById("setModal")) closeSetModal();
  if (e.target == document.getElementById("orderModal")) document.getElementById("orderModal").style.display = 'none';
};

/* ========= Модалка набора ========= */
function openSetModal(setId) {
  const set = (menuData.sets || []).find(s => s.id === setId);
  if (!set) return;
  currentSet = set;
  setModalItems = []; // сброс
  // заполняем список товаров набора, подтягивая данные из menuData.menu
  set.items.forEach(pid => {
    const product = findProductById(pid);
    if (!product) return;
    const step = Number(product.step) || 1; // берём шаг из product.step или 1
    const qty = step; // по умолчанию рекомендуемое количество = шаг
    setModalItems.push({ id: product.id, qty, step, product });
  });
  setModalQty = 1;

  // заполнение модалки DOM
  document.getElementById("setModalName").textContent = set.name;
  document.getElementById("setModalDesc").textContent = set.description || '';
  document.getElementById("setModalImage").src = "images/" + (set.images || '');
  renderSetModalItems();
  updateSetModalTotals();

  document.getElementById("setQtyValue").textContent = setModalQty;
  document.getElementById("setModal").style.display = "block";
}
function closeSetModal() { document.getElementById("setModal").style.display = "none"; currentSet = null; setModalItems = []; }

function renderSetModalItems(){
  const container = document.getElementById("setItemsList");
  container.innerHTML = '';
  setModalItems.forEach((si, idx) => {
    const p = si.product;
    const row = document.createElement('div');
    row.className = 'set-item-row';
    row.innerHTML = `
      <div class="left">
        <img src="images/${p.images || ''}" alt="${p.name}">
        <div>
          <div><strong>${p.name}</strong></div>
          <div class="w3-small w3-text-grey">${p.price} грн | ${p.unit || ''}</div>
        </div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="qty-controls">
          <button class="w3-button w3-round" data-idx="${idx}" data-action="minus">-</button>
          <span id="set_item_qty_${idx}">${si.qty}</span>
          <button class="w3-button w3-round" data-idx="${idx}" data-action="plus">+</button>
        </div>
        <div class="w3-small w3-text-grey" id="set_item_total_${idx}">${(p.price * si.qty)} грн</div>
      </div>
    `;
    container.appendChild(row);
  });

  // делегирование для плюс/минус в модалке набора (обрабатываем кнопки)
  container.querySelectorAll('button[data-action]').forEach(btn=>{
    btn.onclick = (ev) => {
      ev.stopPropagation();
      const idx = Number(btn.getAttribute('data-idx'));
      const action = btn.getAttribute('data-action');
      const item = setModalItems[idx];
      if (!item) return;
      if (action === 'plus') {
        item.qty += item.step;
      } else {
        if (item.qty - item.step >= item.step) item.qty -= item.step;
      }
      document.getElementById(`set_item_qty_${idx}`).textContent = item.qty;
      const totalEl = document.getElementById(`set_item_total_${idx}`);
      totalEl.textContent = (item.product.price * item.qty) + " грн";
      updateSetModalTotals();
    };
  });
}

// управление количеством самого набора (умножитель)
document.getElementById("setQtyPlus").onclick = () => {
  setModalQty++; document.getElementById("setQtyValue").textContent = setModalQty; updateSetModalTotals();
};
document.getElementById("setQtyMinus").onclick = () => {
  if (setModalQty > 1) setModalQty--; document.getElementById("setQtyValue").textContent = setModalQty; updateSetModalTotals();
};

function updateSetModalTotals() {
  let total = 0;
  setModalItems.forEach(si => total += si.product.price * si.qty);
  total = total * setModalQty;
  document.getElementById("setTotalPrice").textContent = total + " грн";
}

// кнопка "добавить сет в корзину" (из модалки)
document.getElementById("addSetToCartBtn").onclick = () => {
  if (!currentSet) return;

  // пробегаемся по каждому товару в наборе
  setModalItems.forEach(si => {
    // создаём объект товара как если бы он добавлялся отдельно
    const cartItem = {
      id: si.id,
      name: si.name,
      price: Number(si.price),
      image: si.image,
      unit: si.unit,
      step: si.step || 1,
      quantity: si.qty * setModalQty, // учитываем количество набора
      fromSet: currentSet.id // пометка, что товар из этого набора
    };

    // если этот товар из того же набора уже в корзине — увеличиваем количество
    const existing = cart.find(c => c.id === cartItem.id && c.fromSet === currentSet.id);
    if (existing) {
      existing.quantity += cartItem.quantity;
    } else {
      cart.push(cartItem);
    }
  });

  saveState();
  updateCartCount();
  closeSetModal();
};


/* ========= Навигация верхнего меню (заменил прежний индексный обработчик) ========= */
document.getElementById("searchIcon").onclick = () => {
  // открываем поиск - используем прежний activateTab для анимации
  activateTab(0,"right");
};

document.getElementById("topNav").addEventListener('click', (e) => {
  const a = e.target.closest('a');
  if (!a) return;
  e.preventDefault();

  // remove active visual from top nav and set on the clicked relevant ones (Menu/Favorites/Cart)
  document.querySelectorAll('#topNav a').forEach(x => x.classList.remove('active'));
  const href = a.getAttribute('href') || '';
  if (href === '#menu' || href === '#favorites' || href === '#cart' || href === '#sets') {
    a.classList.add('active');
  }

  if (href === '#menu') {
    showMenu();
    // rebuild bottom nav for menu categories
    buildMenuNav(menuData.categories);
  } else if (href === '#favorites') {
    showFavorites();
  } else if (href === '#cart') {
    showCart();
  } else if (href === '#sets') {
    // show set categories in bottom nav
    buildSetCategories(menuData.setCategories || []);
    // auto-select first set category if exists
    const cats = menuData.setCategories || [];
    if (cats.length) showSets(cats[0].id);
    else {
      // no categories — show all sets
      showSets(null);
    }
  }
});

/* ========= Построение категорий наборов в нижнем меню ========= */
function buildSetCategories(cats) {
  const nav = document.getElementById("categoryNav"); 
  nav.innerHTML = '';

  cats.forEach((cat, index) => {
    const a = document.createElement("a");
    a.href = "#" + cat.id;
    a.textContent = cat.name;

    a.addEventListener('click', (e) => {
      e.preventDefault();
      // подсветка нижнего меню
      document.querySelectorAll('#categoryNav a').forEach(x => x.classList.remove('active'));
      a.classList.add('active');
      showSets(cat.id);
    });

    // 👉 делаем первую категорию активной по умолчанию
    if (index === 0) {
      a.classList.add('active');
      showSets(cat.id);
    }

    nav.appendChild(a);
  });

  navLinks = nav.querySelectorAll("a");
}


/* ========= Отображение наборов по категории (или всех, если categoryId = null) ========= */
function showSets(categoryId) {
  clearFixedBuy();
  const content = document.getElementById("content");
  content.classList.remove("content-left", "content-right");
  content.innerHTML = '<h2 style="margin-top:70px">Наборы</h2>';
  document.getElementById("categoryNav").style.display = "block";

  const allSets = menuData.sets || [];
  let filtered = allSets;
  if (categoryId) filtered = allSets.filter(s => s.category === categoryId);

  if (!filtered.length) { content.innerHTML += "<p>Ничего не найдено</p>"; return; }

  filtered.forEach(set => {
    // карточка набора
    content.appendChild(renderSetCard(set));
  });
  setTimeout(scrollTopNavToActive,150);
}

/* ========= Инициализация: загрузка menu.json и шаблона card.html ========= */
Promise.all([fetch("menu.json").then(r => r.json()), fetch("card.html").then(r => r.text())])
  .then(([data, tpl]) => {
    menuData = data; cardTemplate = tpl;
    loadState();
    // при старте отображаем меню и строим нижнее меню категорий товаров
    buildMenuNav(menuData.categories || []);
    showMenu();
    updateFavCount(); updateCartCount();
  }).catch(err => {
    console.error("Ошибка загрузки menu.json или card.html:", err);
    document.getElementById("content").innerHTML = "<p style='padding:20px;color:red'>Ошибка загрузки данных. Проверь menu.json и card.html в том же каталоге.</p>";
  });

/* ========= Подсветка нижнего меню (observing sections) ========= */
function observeSections() {
  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        navLinks.forEach(l => {
          const active = l.getAttribute("href") === "#" + entry.target.id;
          l.classList.toggle("active", active);
          if (active) l.scrollIntoView({ behavior: "smooth", inline: "center", block: "nearest" });
        });
      }
    });
  }, { threshold: 0.5 });
  sections.forEach(sec => observer.observe(sec));
}

/* ========= Заказ (без изменений) ========= */
function openOrderForm(total) {
  document.getElementById('orderTotal').textContent = total;
  document.getElementById('formTotal').value = total;
  document.getElementById('formCart').value = JSON.stringify(cart);
  document.getElementById('orderModal').style.display = 'block';
}
</script>

</body>
</html>
