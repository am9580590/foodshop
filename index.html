<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ—Ü—ñ–Ω–∫–∏ ‚Äî –ø–æ–≤–Ω–∞ –≤–µ—Ä—Å—ñ—è</title>
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --accent:#2563eb; --muted:#64748b;
    --radius:12px;
  }
  body{
    font-family: Inter, Roboto, system-ui, Arial, sans-serif;
    background:var(--bg); color:#0f172a; margin:0; padding:20px;
  }
  .wrap{max-width:1200px;margin:0 auto}
  .card{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:0 10px 30px rgba(15,23,42,0.06)}
  h1{font-size:18px;margin:0 0 12px;text-align:center}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  label{font-size:13px}
  input[type=number], input[type=url], select, input[type=text]{padding:8px;border:1px solid #d1d5db;border-radius:8px;box-sizing:border-box}
  input[type=number]{width:140px}
  button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:10px;cursor:pointer}
  button.ghost{background:transparent;color:var(--accent);border:1px solid #dbeafe}
  .small{font-size:12px;color:var(--muted)}
  .right{margin-left:auto}
  .hidden{display:none}
  .result-box{margin-top:12px;padding:12px;border-radius:10px;background:#f8fafc;border:1px solid #e6eef6}
  .url-ind{cursor:pointer;padding:4px 8px;border-radius:6px;background:#eef2ff;border:1px solid #dbeafe;color:#0b5cff}
  .highlight-chosen{background:#eefdf0}
  .highlight-dropped{background:#fff6f6}
  .editable-corr{width:80px;padding:6px;border-radius:6px;border:1px solid #cbd5e1}
  .muted-2{color:#475569;font-size:13px}
  .controls {display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .note{font-size:12px;color:var(--muted);margin-top:8px}
  .table-container { display:block; overflow-x:auto; width:100%; -webkit-overflow-scrolling:touch; padding-bottom:8px; }
  table.vert{border-collapse:collapse;margin-top:12px;font-size:13px;width:max-content;min-width:100%}
  table.vert th, table.vert td{border:1px solid #e6eef6;padding:10px;text-align:center;vertical-align:middle}
  table.vert th{background:#f1f5f9;font-weight:600}
  select{width:100%;max-width:160px}
  .inp-num{width:100px}
  .th-add { display:flex; align-items:center; justify-content:center; }
  .add-btn{ background:transparent;color:var(--accent);border:1px dashed #c7ddff;border-radius:6px;padding:6px 8px;font-weight:700;cursor:pointer; }
  .steps-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  @media (max-width:900px){
    .card{padding:14px}
    input[type=number]{width:120px}
    table.vert{display:block;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch}
    button{width:100%}
    .row{gap:8px}
    .right{margin-left:0}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ—Ü—ñ–Ω–∫–∏ ‚Äî –ø–æ–≤–Ω–∞ –≤–µ—Ä—Å—ñ—è</h1>

    <!-- Stage 1: –≤–≤–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π) -->
    <div id="stage1">
      <h3>–ï—Ç–∞–ø 1 ‚Äî –ü–æ—á–∞—Ç–∫–æ–≤—ñ –¥–∞–Ω—ñ</h3>
      <div class="row" style="align-items:center">
        <label>–ú—ñ—Å—Ç–æ:
          <select id="s_city">
            <option value="odesa" selected>–û–¥–µ—Å–∞</option>
            <option value="kyiv">–ö–∏—ó–≤</option>
            <option value="lviv">–õ—å–≤—ñ–≤</option>
            <option value="dnipro">–î–Ω—ñ–ø—Ä–æ</option>
            <option value="kharkiv">–•–∞—Ä–∫—ñ–≤</option>
          </select>
        </label>

        <label>–ö—ñ–º–Ω–∞—Ç: <input id="s_rooms" type="number" min="1" value="2"></label>
        <label>–ü–æ–≤–µ—Ä—Ö (–æ–±'—î–∫—Ç–∞): <input id="s_floorNum" type="number" min="1" value="3"></label>
        <label>–ü–æ–≤–µ—Ä—Ö–æ–≤—ñ—Å—Ç—å: <input id="s_totalFloors" type="number" min="1" value="5"></label>
      </div>

      <div class="row" style="align-items:center;margin-top:8px">
        <label>–ü–ª–æ—â–∞ –æ–±'—î–∫—Ç–∞ (–º¬≤): <input id="s_area" type="number" min="1" placeholder="–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ 50"></label>
        <label>–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å (‚Ç¥): <input id="s_priceUAH" type="number" min="0" placeholder="–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ 1500000"></label>
        <label>–ö—É—Ä—Å –¥–æ–ª–∞—Ä–∞ (‚Ç¥ ‚Üí $): <input id="s_usdRate" type="number" min="0" step="0.01" placeholder="–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ 40.5"></label>
        <div class="right small">–Ø–∫—â–æ –Ω–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ ‚Äî –º–æ–∂–Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–∏ –¥–∞–ª—ñ</div>
      </div>

      <div class="steps-row">
        <button id="btnNext">–î–∞–ª—ñ</button>
        <button id="btnSkip" class="ghost">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏</button>
      </div>
    </div>

    <!-- Stage 1.5: –¥–∏–∞–ø–∞–∑–æ–Ω + LUN link -->
    <div id="stageRange" class="hidden" style="margin-top:12px">
      <h3>–û—Ä—ñ—î–Ω—Ç–∏—Ä ‚Äî —Ü—ñ–Ω–∞ –∑–∞ –º¬≤ & –ø–æ—à—É–∫ –∞–Ω–∞–ª–æ–≥—ñ–≤</h3>
      <div class="row">
        <div id="rangeText" style="font-weight:700"></div>
        <div class="right">
          <a id="lunLink" href="#" target="_blank" class="small" style="display:inline-block;margin-right:8px">üîó –í—ñ–¥–∫—Ä–∏—Ç–∏ –ø–æ—à—É–∫ —É LUN</a>
          <button id="btnRangeNext">–î–∞–ª—ñ –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</button>
        </div>
      </div>
      <div style="margin-top:8px">
        <div id="objectSummary" class="small"></div>
      </div>
      <div style="margin-top:8px">
        <button id="btnRangeBack" class="ghost">–ù–∞–∑–∞–¥</button>
      </div>
    </div>

    <!-- Stage 2: –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä -->
    <div id="stageCalc" class="hidden" style="margin-top:12px">
      <h3>–ï—Ç–∞–ø 2 ‚Äî –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h3>

      <div class="row" style="align-items:flex-end">
        <div style="min-width:420px">
          <div class="small">–û–±'—î–∫—Ç –æ—Ü—ñ–Ω–∫–∏</div>
          <div class="row" style="margin-top:6px">
            <label>–ü–ª–æ—â–∞ (–º¬≤): <input id="objArea" type="number" min="1" placeholder="–ø–ª–æ—â–∞ –∑ –ø–µ—Ä—à–æ–≥–æ –∫—Ä–æ–∫—É"></label>
            <label>–°—Ç–∞–Ω:
              <select id="objState">
                <option value="0">–Ω–µ–∑–∞–¥–æ–≤—ñ–ª—å–Ω–∏–π</option>
                <option value="5">–∑–∞–¥–æ–≤—ñ–ª—å–Ω–∏–π</option>
                <option value="10" selected>–¥–æ–±—Ä–∏–π</option>
                <option value="15">–≤—ñ–¥–º—ñ–Ω–Ω–∏–π</option>
              </select>
            </label>
            <label>–ü–æ–≤–µ—Ä—Ö:
              <select id="objFloor">
                <option value="first">–ø–µ—Ä—à–∏–π</option>
                <option value="middle" selected>—Å–µ—Ä–µ–¥–Ω—ñ–π</option>
                <option value="last">–æ—Å—Ç–∞–Ω–Ω—ñ–π</option>
              </select>
            </label>
          </div>
        </div>

        <div style="margin-left:auto;min-width:220px">
          <div class="small">–ü–æ–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Ç–æ—Ä–≥ (–∑–∞–≥–∞–ª—å–Ω–∞ ‚Äî –≤—Ä—É—á–Ω—É –∞–±–æ –ø—É—Å—Ç–æ –¥–ª—è –∞–≤—Ç–æ)</div>
          <input id="torgInput" type="number" min="-20" max="0" placeholder="-10" style="width:120px;margin-top:6px">
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∞–Ω–∞–ª–æ–≥—ñ–≤ –¥–ª—è –ø—ñ–¥—Å—É–º–∫—É:
          <select id="analogsCount">
            <option value="4">4</option>
            <option value="5" selected>5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
          </select>
        </label>

        <div style="margin-left:auto">
          <div class="controls"></div>
        </div>
      </div>

      <div class="note">–¢–∞–±–ª–∏—Ü—è –≤–≤–µ–¥–µ–Ω–Ω—è: –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∑–≤–µ—Ä—Ö—É –≤–Ω–∏–∑, –∞–Ω–∞–ª–æ–≥–∏ –ø–æ –∫–æ–ª–æ–Ω–∫–∞—Ö. –ó–º—ñ–Ω—é–π—Ç–µ –¥–∞–Ω—ñ –≤ –∫–ª—ñ—Ç–∏–Ω–∫–∞—Ö ‚Äî –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ ¬´–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏¬ª –≤–æ–Ω–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –≤ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è—Ö.</div>

      <div id="inputTableContainer" class="table-container" style="margin-top:12px"></div>

      <div style="margin-top:10px" class="steps-row">
        <button id="btnCalc" class="btn-primary">–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
        <button id="btnCalcBack" class="ghost">–ù–∞–∑–∞–¥</button>
      </div>

      <div id="calcNote" class="small" style="margin-top:8px">–Ø–∫—â–æ –∞–Ω–∞–ª–æ–≥—ñ–≤ –±—ñ–ª—å—à–µ, –Ω—ñ–∂ N ‚Äî –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—ñ–¥–±–µ—Ä–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω—É –ø—ñ–¥–≥—Ä—É–ø—É.</div>
    </div>

    <!-- Output -->
    <div id="outputWrap" class="hidden" style="margin-top:12px">
      <div class="steps-row" style="align-items:center">
        <div id="appliedTorg" class="muted-2" style="margin-bottom:6px"></div>
        <div class="right">
          <button id="btnOutputBack" class="ghost">–ù–∞–∑–∞–¥</button>
        </div>
      </div>
      <div id="output" class="result-box"></div>
    </div>

  </div>
</div>

<script>
  
document.addEventListener('DOMContentLoaded', () => {
  /* ---------- Helpers ---------- */
  const $ = id => document.getElementById(id);
  const toUSD = n => '$' + Number(Math.round(n)).toLocaleString('en-US');
  const toUAH = (n, rate) => '‚Ç¥' + Number(Math.round(n * rate)).toLocaleString('en-US');
  const clamp = (v,a,b) => Math.max(a, Math.min(b, v));

  /* ---------- Elements (stage navigation) ---------- */
  const btnNext = $('btnNext'), btnSkip = $('btnSkip');
  const btnRangeNext = $('btnRangeNext'), btnRangeBack = $('btnRangeBack');
  const btnCalc = $('btnCalc'), btnCalcBack = $('btnCalcBack');
  const btnOutputBack = $('btnOutputBack');

  const stage1 = $('stage1'), stageRange = $('stageRange'), stageCalc = $('stageCalc'), outputWrap = $('outputWrap');

  /* ---------- Inputs (step1 ‚Üí stageRange) ---------- */
  const s_city = $('s_city'), s_rooms = $('s_rooms'), s_floorNum = $('s_floorNum'), s_totalFloors = $('s_totalFloors');
  const s_area = $('s_area'), s_priceUAH = $('s_priceUAH'), s_usdRate = $('s_usdRate');

  const rangeText = $('rangeText'), objectSummary = $('objectSummary'), lunLink = $('lunLink');

  /* ---------- Inputs (calculator) ---------- */
  const objArea = $('objArea'), objState = $('objState'), objFloor = $('objFloor');
  const torgInput = $('torgInput'), analogsCount = $('analogsCount'), inputTableContainer = $('inputTableContainer');

  const appliedTorgEl = $('appliedTorg'), output = $('output');

  /* ---------- State ---------- */
  let recommended = null; // {low, high, rate, totalUAH}
  let autoAppliedTorg = null;
  let analogsData = [];
  let manualOverrides = {}; // { id: { stateCorr, areaCorr, floorCorr } }

  /* ---------- LUN URL generation ---------- */
  function floorCountMapFor(totalFloors){
    const map = {
      1: {min:1,max:1},
      2: {min:2,max:4},
      3: {min:2,max:4},
      4: {min:2,max:4},
      5: {min:4,max:6},
      6: {min:5,max:8},
      7: {min:6,max:12},
      8: {min:6,max:12},
      9: {min:8,max:999},
    };
    return map[totalFloors] || {min: Math.max(2, totalFloors-2), max: totalFloors+3};
  }
  function generateLunUrl(obj){
    const base = "https://lun.ua/sale";
    const city = (obj.city || 'odesa');
    const rooms = obj.rooms || 1;
    const minP = Math.max(0, Math.round(obj.pricePerSqm || 0));
    const maxP = Math.max(minP, Math.round((obj.pricePerSqm || 0) * 1.2));
    const totalFloors = obj.totalFloors || 5;
    const floorRange = floorCountMapFor(totalFloors);
    let isNotFirst = false, isNotLast = false;
    const floorNum = obj.floorNum || 1;
    if (floorNum > 1 && floorNum < totalFloors) { isNotFirst = true; isNotLast = true; }
    return `${base}/${city}/flats?room_count=${rooms}&price_sqm_min=${minP}&price_sqm_max=${maxP}&currency=USD&is_not_first_floor=${isNotFirst}&is_not_last_floor=${isNotLast}&floor_count_min=${floorRange.min}&floor_count_max=${floorRange.max}`;
  }

  /* ---------- Stage navigation (Step1 -> StepRange) ---------- */
  btnNext.addEventListener('click', () => {
    const areaVal = Number(s_area.value) || NaN;
    const totalUAH = Number(s_priceUAH.value) || NaN;
    const rate = Number(s_usdRate.value) || NaN;

    // compute recommended range if all provided
    if (!isNaN(areaVal) && areaVal>0 && !isNaN(totalUAH) && totalUAH>0 && !isNaN(rate) && rate>0) {
      const base = totalUAH / areaVal / rate;
      recommended = { low: base, high: base*1.2, rate, totalUAH };
      rangeText.textContent = `${toUSD(recommended.low)} ‚Äì ${toUSD(recommended.high)} –∑–∞ –º¬≤`;
    } else {
      recommended = null;
      rangeText.textContent = `–î–∞–Ω—ñ –Ω–µ–ø–æ–≤–Ω—ñ ‚Äî –¥—ñ–∞–ø–∞–∑–æ–Ω –Ω–µ –æ–±—á–∏—Å–ª–µ–Ω–æ.`;
    }

    // summary + LUN link
    const obj = {
      city: s_city.value,
      rooms: Number(s_rooms.value) || 1,
      floorNum: Number(s_floorNum.value) || 1,
      totalFloors: Number(s_totalFloors.value) || 1,
      pricePerSqm: recommended ? recommended.low : 0
    };

    objectSummary.textContent = `–ú—ñ—Å—Ç–æ: ${s_city.options[s_city.selectedIndex].text}; –ö—ñ–º–Ω–∞—Ç: ${obj.rooms}; –ü–æ–≤–µ—Ä—Ö: ${obj.floorNum}; –ü–æ–≤–µ—Ä—Ö–æ–≤—ñ—Å—Ç—å: ${obj.totalFloors}; –ü–ª–æ—â–∞: ${s_area.value || '-' } –º¬≤`;

    const lunUrl = generateLunUrl(obj);
    lunLink.href = lunUrl;
    lunLink.textContent = `üîó –í—ñ–¥–∫—Ä–∏—Ç–∏ –ø–æ—à—É–∫ —É LUN (${s_city.options[s_city.selectedIndex].text})`;

    // show next
    stage1.classList.add('hidden');
    stageRange.classList.remove('hidden');
  });

  $('btnSkip').addEventListener('click', ()=> {
    stage1.classList.add('hidden');
    stageRange.classList.add('hidden');
    showStageCalc();
  });

  btnRangeBack.addEventListener('click', ()=> {
    stageRange.classList.add('hidden');
    stage1.classList.remove('hidden');
  });

  btnRangeNext.addEventListener('click', ()=> {
    stageRange.classList.add('hidden');
    showStageCalc();
  });

  /* ---------- showStageCalc: prefill objArea and render table ---------- */
  function showStageCalc(){
    stageCalc.classList.remove('hidden');
    outputWrap.classList.add('hidden'); // hide result until calculated
    if (s_area.value) objArea.value = s_area.value;
    if (analogsData.length === 0) generateAnalogsData(5);
    renderInputTable();
  }

  /* ---------- Analogs management ---------- */
  function generateAnalogsData(n){
    analogsData = [];
    for (let i=0;i<n;i++){
      analogsData.push({
        id: i+1,
        priceUSD: '',
        area: '',
        state: '10',
        floor: 'middle',
        url: ''
      });
    }
  }
  function addAnalog(){
    const id = analogsData.length + 1;
    analogsData.push({ id, priceUSD:'', area:'', state:'10', floor:'middle', url:'' });
    renderInputTable();
  }

  /* ---------- Render input table (vertical) ---------- */
  function renderInputTable(){
    const cols = analogsData.length;
    let html = '<table class="vert"><thead><tr><th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th>';
    for (let c=0;c<cols;c++) html += `<th>–ê–Ω–∞–ª–æ–≥ ${c+1}</th>`;
    html += `<th class="th-add"><button id="btnAddHeader" class="add-btn" title="–î–æ–¥–∞—Ç–∏ –∞–Ω–∞–ª–æ–≥">+</button></th>`;
    html += '</tr></thead><tbody>';

    const rows = [
      {key:'priceUSD', label:'–¶—ñ–Ω–∞ (USD)'},
      {key:'area', label:'–ü–ª–æ—â–∞ (–º¬≤)'},
      {key:'state', label:'–°—Ç–∞–Ω'},
      {key:'floor', label:'–ü–æ–≤–µ—Ä—Ö'},
      {key:'url', label:'–ü–æ—Å–∏–ª–∞–Ω–Ω—è'}
    ];

    const cellInput = (idx, field)=>{
      const val = analogsData[idx][field] ?? '';
      if (field === 'priceUSD' || field === 'area') {
        return `<input data-idx="${idx}" data-field="${field}" class="inp-num" type="number" value="${val}">`;
      }
      if (field === 'url') return `<input data-idx="${idx}" data-field="${field}" type="url" value="${val}">`;
      if (field === 'state') {
        return `<select data-idx="${idx}" data-field="state">
          <option value="0"${val==='0'?' selected':''}>–Ω–µ–∑–∞–¥–æ–≤—ñ–ª—å–Ω–∏–π</option>
          <option value="5"${val==='5'?' selected':''}>–∑–∞–¥–æ–≤—ñ–ª—å–Ω–∏–π</option>
          <option value="10"${val==='10'?' selected':''}>–¥–æ–±—Ä–∏–π</option>
          <option value="15"${val==='15'?' selected':''}>–≤—ñ–¥–º—ñ–Ω–Ω–∏–π</option>
        </select>`;
      }
      if (field === 'floor') {
        return `<select data-idx="${idx}" data-field="floor">
          <option value="first"${val==='first'?' selected':''}>–ø–µ—Ä—à–∏–π</option>
          <option value="middle"${val==='middle'?' selected':''}>—Å–µ—Ä–µ–¥–Ω—ñ–π</option>
          <option value="last"${val==='last'?' selected':''}>–æ—Å—Ç–∞–Ω–Ω—ñ–π</option>
        </select>`;
      }
      return `<input data-idx="${idx}" data-field="${field}" value="${val}">`;
    };

    rows.forEach(r=>{
      html += `<tr><td style="text-align:left;font-weight:600">${r.label}</td>`;
      for (let c=0;c<cols;c++){
        html += `<td>${cellInput(c, r.key)}</td>`;
      }
      html += `<td></td>`;
      html += `</tr>`;
    });

    html += `</tbody></table>`;
    inputTableContainer.innerHTML = html;

    // wire add button
    const btnAddHeader = document.getElementById('btnAddHeader');
    if (btnAddHeader) btnAddHeader.addEventListener('click', ()=> { addAnalog(); });

    // wire inputs to state
    Array.from(inputTableContainer.querySelectorAll('[data-idx]')).forEach(el=>{
      el.addEventListener('input', (e)=>{
        const idx = Number(el.getAttribute('data-idx'));
        const field = el.getAttribute('data-field');
        let v = el.value;
        if (field === 'priceUSD' || field === 'area') v = v === '' ? '' : Number(v);
        analogsData[idx][field] = v;
      });
    });
  }

  /* ---------- Core compute ---------- */
  function computeAllForTorg(torgPercent) {
    const oArea = Number(objArea.value) || 0;
    const oStateVal = Number(objState.value) || 10;
    const oFloorVal = objFloor.value || 'middle';

    return analogsData.map(a => {
      const price = Number(a.priceUSD) || 0;
      const area = Number(a.area) || 0;
      const state = a.state !== '' ? Number(a.state) : 10;
      const floor = a.floor || 'middle';
      const url = a.url || '';

      const stateDerived = (oStateVal - state);
      const areaPoints = Math.round((oArea - area) / 15);
      const areaDerived = -areaPoints;
      let floorDerived = 0;
      if (oFloorVal === 'middle') {
        if (floor === 'first' || floor === 'last') floorDerived = 5;
      } else if (oFloorVal === 'first' || oFloorVal === 'last') {
        if (floor === 'middle') floorDerived = -5;
        else floorDerived = 0;
      }

      const id = a.id;
      const manual = manualOverrides[id] || {};
      const stateCorr = (typeof manual.stateCorr === 'number') ? manual.stateCorr : stateDerived;
      const areaCorr  = (typeof manual.areaCorr === 'number') ? manual.areaCorr : areaDerived;
      const floorCorr = (typeof manual.floorCorr === 'number') ? manual.floorCorr : floorDerived;

      const totalCorrPercent = stateCorr + areaCorr + floorCorr + (torgPercent || 0);
      const correctedPriceUSD = price * (1 + totalCorrPercent / 100);
      const pricePerM2 = area > 0 ? correctedPriceUSD / area : 0;

      return {
        id, priceUSD: price, area, state, floor, url,
        derived: { stateDerived, areaDerived, floorDerived },
        manual: { stateCorr, areaCorr, floorCorr },
        totalCorrPercent,
        correctedPriceUSD,
        pricePerM2
      };
    });
  }

  function chooseBestSubsetByPerM2(allArr, N, recommendedUAH, rate) {
    if (!allArr || allArr.length === 0) return null;
    const sortedAll = [...allArr].sort((a,b)=>a.pricePerM2 - b.pricePerM2);
    if (sortedAll.length <= N) {
      const droppedMin = sortedAll[0], droppedMax = sortedAll[sortedAll.length-1];
      const remaining = sortedAll.slice(1, sortedAll.length-1);
      const avgPerM2 = remaining.length ? remaining.reduce((s,r)=>s + r.pricePerM2,0)/remaining.length : (sortedAll.length ? sortedAll.reduce((s,r)=>s+r.pricePerM2,0)/sortedAll.length : 0);
      return { subset: sortedAll.slice(0,N), avgPerM2, droppedMin, droppedMax, all: sortedAll };
    }

    let best = { subset: sortedAll.slice(0,N), diff: Infinity, avgPerM2: null, droppedMin:null, droppedMax:null };
    for (let i=0; i <= sortedAll.length - N; i++) {
      const window = sortedAll.slice(i, i+N);
      const srt = [...window].sort((a,b)=>a.pricePerM2 - b.pricePerM2);
      const droppedMin = srt[0], droppedMax = srt[srt.length-1];
      const remaining = srt.slice(1, srt.length-1);
      const avgPerM2 = remaining.length ? remaining.reduce((s,r)=>s + r.pricePerM2,0)/remaining.length : 0;
      const estUSD = avgPerM2 * (Number(objArea.value) || 0);
      const estUAH = (rate && rate>0) ? estUSD * rate : estUSD;
      const diff = recommendedUAH ? Math.abs(estUAH - recommendedUAH) : 0;
      if (diff < best.diff) {
        best = { subset: window, diff, avgPerM2, droppedMin, droppedMax };
      }
    }
    return best;
  }

  function autoPickTorgAndSubset() {
    if (!recommended || !recommended.rate) return null;
    const targetUAH = recommended.totalUAH;
    const candidates = [0, -5, -10, -15, -20];
    let bestOverall = { torg: 0, diff: Infinity, result: null };
    for (const t of candidates) {
      const all = computeAllForTorg(t);
      const N = Number(analogsCount.value) || 5;
      const candidate = chooseBestSubsetByPerM2(all, N, targetUAH, recommended.rate);
      if (!candidate) continue;
      const estUSD = candidate.avgPerM2 * (Number(objArea.value) || 0);
      const estUAH = estUSD * recommended.rate;
      const diff = Math.abs(estUAH - targetUAH);
      if (diff < bestOverall.diff) {
        bestOverall = { torg: t, diff, candidate, all, estUSD, estUAH };
      }
    }
    return bestOverall;
  }

  /* ---------- Main calculate flow ---------- */
  function calculateMain() {
    const userTorgRaw = (torgInput.value || '').toString().trim();
    let userTorg = null;
    if (userTorgRaw !== '') userTorg = clamp(Number(userTorgRaw), -20, 0);

    if (userTorg === null && recommended && recommended.rate) {
      const best = autoPickTorgAndSubset();
      if (best && best.candidate) {
        autoAppliedTorg = best.torg;
        renderResult(best.all, best.torg, best.candidate.subset, best.candidate.avgPerM2, best.candidate.droppedMin, best.candidate.droppedMax, best.estUSD, best.estUAH, recommended);
        return;
      }
    }

    const torgToUse = (userTorg !== null) ? userTorg : 0;
    const all = computeAllForTorg(torgToUse);
    const N = Number(analogsCount.value) || 5;
    const candidate = chooseBestSubsetByPerM2(all, N, recommended ? recommended.totalUAH : null, recommended ? recommended.rate : null);

    const estUSD = candidate ? candidate.avgPerM2 * (Number(objArea.value) || 0) : 0;
    const estUAH = (recommended && recommended.rate) ? estUSD * recommended.rate : estUSD;

    autoAppliedTorg = null;
    renderResult(all, torgToUse, candidate ? candidate.subset : [], candidate ? candidate.avgPerM2 : 0, candidate ? candidate.droppedMin : null, candidate ? candidate.droppedMax : null, estUSD, estUAH, recommended);
  }

  /* ---------- Render result (vertical) ---------- */
  function renderResult(allData, torgApplied, chosenSubset, avgPerM2, droppedMin, droppedMax, estUSD, estUAH, recommendObj) {
    appliedTorgEl.textContent = (torgInput.value.trim()==='' && autoAppliedTorg!==null) ? `–ü–æ–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Ç–æ—Ä–≥ (–∞–≤—Ç–æ): ${autoAppliedTorg}%` : `–ü–æ–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Ç–æ—Ä–≥: ${torgApplied}%`;

    const chosenIds = new Set((chosenSubset||[]).map(x => x.id));
    let html = `<h3>–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É</h3>`;
    html += `<div class="muted-2">–ó–µ–ª–µ–Ω–∏–π ‚Äî –æ–±—Ä–∞–Ω—ñ –≤ –ø—ñ–¥—Å—É–º–æ–∫; —á–µ—Ä–≤–æ–Ω–∏–π ‚Äî –≤—ñ–¥–∫–∏–Ω—É—Ç—ñ –º—ñ–Ω/–º–∞–∫—Å.</div>`;
    html += `<div style="overflow:auto"><table class="vert"><thead><tr><th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th>`;

    const droppedMinId = droppedMin ? droppedMin.id : null;
    const droppedMaxId = droppedMax ? droppedMax.id : null;

    allData.forEach((a,i)=> html += `<th>–ê–Ω–∞–ª–æ–≥ ${i+1}${(droppedMinId===a.id) ? ' (–≤—ñ–¥–∫–∏–Ω—É—Ç–æ‚Äî–º—ñ–Ω)' : (droppedMaxId===a.id ? ' (–≤—ñ–¥–∫–∏–Ω—É—Ç–æ‚Äî–º–∞–∫—Å)' : '')}</th>`);
    html += `</tr></thead><tbody>`;

    const params = [
      {key:'priceUSD', label:'–ë–∞–∑–æ–≤–∞ —Ü—ñ–Ω–∞ (USD)'},
      {key:'area', label:'–ü–ª–æ—â–∞ (–º¬≤)'},
      {key:'stateDerived', label:'–°—Ç–∞–Ω (–ø.–ø.) ‚Äî derived'},
      {key:'areaDerived', label:'–ü–ª–æ—â–∞ (–ø.–ø.) ‚Äî derived'},
      {key:'floorDerived', label:'–ü–æ–≤–µ—Ä—Ö (–ø.–ø.) ‚Äî derived'},
      {key:'stateCorr', label:'–ü–æ–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞–Ω (–≤—Ä—É—á–Ω—É %)'},
      {key:'areaCorr', label:'–ü–æ–ø—Ä–∞–≤–∫–∞ –ø–ª–æ—â–∞ (–≤—Ä—É—á–Ω—É %)'},
      {key:'floorCorr', label:'–ü–æ–ø—Ä–∞–≤–∫–∞ –ø–æ–≤–µ—Ä—Ö (–≤—Ä—É—á–Ω—É %)'},
      {key:'totalCorr', label:'–ó–∞–≥–∞–ª—å–Ω–∞ –∫–æ—Ä–µ–∫—Ü—ñ—è (%)'},
      {key:'correctedPriceUSD', label:'–°–∫–æ—Ä–∏–≥–æ–≤–∞–Ω–∞ —Ü—ñ–Ω–∞ (USD)'},
      {key:'pricePerM2', label:'–¶—ñ–Ω–∞ –∑–∞ –º¬≤ (USD/m¬≤)'},
      {key:'url', label:'URL'},
      {key:'chosen', label:'–£ –ø—ñ–¥—Å—É–º–∫—É?'}
    ];

    allData.forEach(a=> { a.pricePerM2 = a.pricePerM2 || 0; });

    params.forEach(p=>{
      html += `<tr><td style="text-align:left;font-weight:600">${p.label}</td>`;
      allData.forEach(a=>{
        if (p.key === 'priceUSD') html += `<td>${a.priceUSD ? toUSD(a.priceUSD) : '-'}</td>`;
        else if (p.key === 'area') html += `<td>${a.area || '-'}</td>`;
        else if (p.key === 'stateDerived') html += `<td>${a.derived ? a.derived.stateDerived : '-'}</td>`;
        else if (p.key === 'areaDerived') html += `<td>${a.derived ? a.derived.areaDerived : '-'}</td>`;
        else if (p.key === 'floorDerived') html += `<td>${a.derived ? a.derived.floorDerived : '-'}</td>`;
        else if (p.key === 'stateCorr') {
          const manualVal = manualOverrides[a.id] && typeof manualOverrides[a.id].stateCorr === 'number' ? manualOverrides[a.id].stateCorr : (a.manual ? a.manual.stateCorr : a.derived.stateDerived);
          html += `<td><input class="editable-corr res-corr" data-id="${a.id}" data-field="stateCorr" type="number" value="${manualVal}"></td>`;
        }
        else if (p.key === 'areaCorr') {
          const manualVal = manualOverrides[a.id] && typeof manualOverrides[a.id].areaCorr === 'number' ? manualOverrides[a.id].areaCorr : (a.manual ? a.manual.areaCorr : a.derived.areaDerived);
          html += `<td><input class="editable-corr res-corr" data-id="${a.id}" data-field="areaCorr" type="number" value="${manualVal}"></td>`;
        }
        else if (p.key === 'floorCorr') {
          const manualVal = manualOverrides[a.id] && typeof manualOverrides[a.id].floorCorr === 'number' ? manualOverrides[a.id].floorCorr : (a.manual ? a.manual.floorCorr : a.derived.floorDerived);
          html += `<td><input class="editable-corr res-corr" data-id="${a.id}" data-field="floorCorr" type="number" value="${manualVal}"></td>`;
        }
        else if (p.key === 'totalCorr') html += `<td>${Math.round(a.totalCorrPercent || 0)}%</td>`;
        else if (p.key === 'correctedPriceUSD') html += `<td>${a.correctedPriceUSD ? toUSD(a.correctedPriceUSD) : '-'}</td>`;
        else if (p.key === 'pricePerM2') html += `<td>${a.pricePerM2 ? ('$' + (Math.round(a.pricePerM2*100)/100)) : '-'}</td>`;
        else if (p.key === 'url') html += `<td>${a.url ? `<span class="url-ind" data-url="${encodeURIComponent(a.url)}">‚úÖ</span>` : ''}</td>`;
        else if (p.key === 'chosen') html += `<td>${chosenIds.has ? (chosenIds.has(a.id) ? '‚úÖ' : '') : ''}</td>`;
        else html += `<td>-</td>`;
      });
      html += `</tr>`;
    });

    html += `</tbody></table></div>`;

    // recommended & final results (simple)
    if (recommendObj && recommendObj.rate) {
      html += `<div style="margin-top:12px"><strong>–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∞ –ø–æ–≤–Ω–∞ —Ü—ñ–Ω–∞:</strong> ‚Ç¥${Number(recommendObj.totalUAH).toLocaleString()} ‚Üí ~${toUSD(Math.round(recommendObj.totalUAH / recommendObj.rate))} (–∫—É—Ä—Å ${recommendObj.rate})</div>`;
    } else if (recommendObj && recommendObj.totalUAH) {
      html += `<div style="margin-top:12px"><strong>–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∞ –ø–æ–≤–Ω–∞ —Ü—ñ–Ω–∞:</strong> ‚Ç¥${Number(recommendObj.totalUAH).toLocaleString()}</div>`;
    }

    html += `<div style="margin-top:12px"><strong>–°–µ—Ä–µ–¥–Ω—è —Ü—ñ–Ω–∞ –∑–∞ –º¬≤ (USD):</strong> ${avgPerM2 ? ('$' + (Math.round(avgPerM2*100)/100)) : '-'}</div>`;
    html += `<div style="margin-top:6px"><strong>–û—Ü—ñ–Ω–æ—á–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å –æ–±'—î–∫—Ç–∞:</strong> ${toUSD(Math.round(estUSD || 0))}${(recommendObj && recommendObj.rate) ? ' / ' + toUAH(Math.round(estUSD || 0), recommendObj.rate) : ''}</div>`;

    if (recommendObj && recommendObj.totalUAH) {
      const diffUAH = Math.round((estUAH || 0) - recommendObj.totalUAH);
      const sign = diffUAH >= 0 ? '+' : '';
      html += `<div style="margin-top:6px" class="muted-2">–†—ñ–∑–Ω–∏—Ü—è –∑ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ—é: ${sign}${diffUAH} ‚Ç¥</div>`;
    }
    html += `<div style="margin-top:10px" class="muted-2">–ü–æ–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Ç–æ—Ä–≥ (–∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–∞): ${torgApplied}%</div>`;

    output.innerHTML = html;
    outputWrap.classList.remove('hidden');

    // bind URL copy
    Array.from(output.querySelectorAll('.url-ind')).forEach(el => {
      el.addEventListener('click', async () => {
        const url = decodeURIComponent(el.getAttribute('data-url') || '');
        if (!url) return;
        try { await navigator.clipboard.writeText(url); const old = el.textContent; el.textContent = '–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ'; setTimeout(()=> el.textContent = old,800); } catch(e){ window.prompt('–ö–æ–ø—ñ—é–π—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è:', url); }
      });
    });

    // bind editable correction inputs (recalculate on change)
    Array.from(output.querySelectorAll('input.res-corr')).forEach(inp => {
      inp.addEventListener('change', () => {
        const id = Number(inp.getAttribute('data-id'));
        const field = inp.getAttribute('data-field'); // stateCorr / areaCorr / floorCorr
        const val = Number(inp.value) || 0;
        if (!manualOverrides[id]) manualOverrides[id] = {};
        manualOverrides[id][field] = val;
        calculateMain();
      });
    });
  }

  /* ---------- Events ---------- */
  // add header button guard (renderInputTable wires it as well)
  if ($('btnAddHeader')) $('btnAddHeader').addEventListener('click', addAnalog);
  if (btnCalc) btnCalc.addEventListener('click', ()=> calculateMain());

  /* ---------- Back buttons ---------- */
  if (btnCalcBack) btnCalcBack.addEventListener('click', ()=> {
    stageCalc.classList.add('hidden');
    stageRange.classList.remove('hidden');
  });
  if (btnOutputBack) btnOutputBack.addEventListener('click', ()=> {
    outputWrap.classList.add('hidden');
    stageCalc.classList.remove('hidden');
  });

  /* ---------- Init ---------- */
  generateAnalogsData(5);
  renderInputTable();
}); // DOMContentLoaded



  
</script>
</body>
</html>
