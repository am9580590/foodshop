<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1">
<title>–ú–∞–≥–∞–∑–∏–Ω —Å –∫–æ—Ä–∑–∏–Ω–æ–π –∏ –∏–∑–±—Ä–∞–Ω–Ω—ã–º</title>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  /* --- —Ç–≤–æ–∏ —Å—Ç–∏–ª–∏ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã) --- */
  #content { transition: transform 0.1s ease; }
  .content-left { transform: translateX(200px); opacity: 0; }
  .content-right { transform: translateX(-200px); opacity: 0; }
  .content-active { opacity: 1; }
  #content h2 { margin-top: 60px; /* —á—É—Ç—å –±–æ–ª—å—à–µ, —á–µ–º –≤—ã—Å–æ—Ç–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –º–µ–Ω—é */ }
  .search-box { display: inline-flex; align-items: center; position: relative; transition: width 0.3s ease; overflow: hidden; vertical-align: middle; width: 40px; }
  .search-box.active { width: 200px; }
  .search-box input { border: 1px solid #ccc; border-radius: 30px; padding: 5px 10px; font-size: 14px; width: 100%; opacity: 0; transition: opacity 0.3s ease; }
  .search-box.active input { opacity: 1; }
  body { margin:0; font-family:Arial,sans-serif; scroll-behavior:smooth; }
  .top-nav { position:fixed; top:0; left:0; right:0; background:white; z-index:9998; padding:2px; white-space:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch; overflow-anchor: none; }
  .top-nav a {display:inline-block;padding:14px 16px;text-decoration:none;color:black;}
  .top-nav a.active {border:1px solid maroon;border-radius:30px;color:maroon;font-weight:600;}
  .count-badge {background:maroon;color:white;border-radius:50%;padding:2px 7px;font-size:12px;margin-left:5px;vertical-align:middle;font-weight:600;}
  .category-nav {position:fixed;bottom:0;left:0;right:0;background:white;overflow-x:auto;white-space:nowrap;border-top:1px solid #ccc;z-index: 1;}
  .category-nav a {display:inline-block;padding:14px 16px;text-decoration:none;color:black;transition:0.3s;}
  .category-nav a.active {background:maroon;color:white;border-radius:30px;font-weight:600;}
  .content {padding:60px 0 60px 0;}
  .section {padding:20px;margin-bottom:40px;border-bottom:1px solid #ccc;}
  .w3-modal-content {position:fixed;bottom:0;left:0;right:0;max-width:700px;margin:auto;}
  .square-image {width:100%;height:300px;overflow:hidden;}
  .square-image img {width:100%;height:100%;object-fit:cover;}
  .like-container {cursor:pointer;display:flex;align-items:center;gap:4px;}
  .like-btn {color:red;font-size:20px;}
  .fixed-buy {position:fixed;left:0;right:0;bottom:0;background:#fff;box-shadow:0 -2px 6px rgba(0,0,0,.1);padding:10px 16px;z-index:9997;}
  .fixed-buy .sum {font-weight:700;margin:0 0 8px;}
  /* –Ω–µ–±–æ–ª—å—à–æ–π —Å—Ç–∏–ª—å –¥–ª—è —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –º–æ–¥–∞–ª–∫–µ —Å–µ—Ç–∞ */
  .set-item-row {display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;}
  .set-item-row .left {display:flex;gap:10px;align-items:center;}
  .set-item-row img {width:64px;height:64px;object-fit:cover;border-radius:6px;}
  .qty-controls button {min-width:36px;}
</style>
</head>
<body>

<!-- –í–µ—Ä—Ö–Ω–µ–µ –º–µ–Ω—é -->
<div id="topNav" class="top-nav">
  <div id="searchBox" class="search-box">
    <i id="searchIcon" class="fa fa-search" style="cursor:pointer;padding:14px 10px;"></i>
    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫...">
  </div>

  <!-- –ø–æ—Ä—è–¥–æ–∫ —Å—Å—ã–ª–æ–∫: –º–µ–Ω—é, –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, –∫–æ—Ä–∑–∏–Ω–∞, –Ω–∞–±–æ—Ä—ã -->
  <a href="#menu" class="active" data-role="menu">–ú–µ–Ω—é</a>
  <a href="#favorites" data-role="favorites">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ 
    <span id="favCount" class="count-badge" style="display:none"></span>
  </a>
  <a href="#cart" data-role="cart">–ö–æ—Ä–∑–∏–Ω–∞ 
    <span id="cartCount" class="count-badge" style="display:none"></span>
  </a>
  <a href="#sets" data-role="sets" id="topSetsLink">–ù–∞–±–æ—Ä—ã</a>
</div>

<!-- –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
<div id="categoryNav" class="category-nav"></div>

<!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
<div class="content" id="content"></div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç–æ–≤–∞—Ä–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤) -->
<div id="productModal" class="w3-modal">
  <div class="w3-modal-content w3-animate-bottom">
    <header class="square-image">
      <span onclick="closeModal()" class="w3-button w3-display-topright">&times;</span>
      <img id="modalImage" src="" alt="">
    </header>
    <div class="w3-container" style="padding-bottom:20px;">
      <h3 id="modalName"></h3>
      <div style="display:flex;justify-content:space-between;">
        <p id="modalPrice"></p><p id="modalWeight"></p>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-top:15px;">
        <div>
          <button id="qtyMinus" class="w3-button w3-black w3-round">-</button>
          <span id="qtyValue">1</span>
          <button id="qtyPlus" class="w3-button w3-black w3-round">+</button>
        </div>
        <p id="totalPrice" style="font-weight:bold;">0 –≥—Ä–Ω</p>
        <button class="w3-button w3-green" onclick="addToCart()">–í –∫–æ—Ä–∑–∏–Ω—É</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞–±–æ—Ä–∞ -->
<div id="setModal" class="w3-modal">
  <div class="w3-modal-content w3-animate-bottom">
    <header class="square-image">
      <span onclick="closeSetModal()" class="w3-button w3-display-topright">&times;</span>
      <img id="setModalImage" src="" alt="">
    </header>
    <div class="w3-container" style="padding-bottom:10px;">
      <h3 id="setModalName"></h3>
      <p id="setModalDesc" class="w3-small w3-text-grey"></p>

      <div id="setItemsList"></div>

      <div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px;">
        <div>
          <button id="setQtyMinus" class="w3-button w3-black w3-round">-</button>
          <span id="setQtyValue">1</span>
          <button id="setQtyPlus" class="w3-button w3-black w3-round">+</button>
        </div>
        <p id="setTotalPrice" style="font-weight:bold;">0 –≥—Ä–Ω</p>
        <button class="w3-button w3-green" id="addSetToCartBtn">–í –∫–æ—Ä–∑–∏–Ω—É</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
<div id="orderModal" class="w3-modal">
  <div class="w3-modal-content w3-animate-bottom">
    <header class="w3-container w3-teal">
      <span onclick="document.getElementById('orderModal').style.display='none'" class="w3-button w3-display-topright">&times;</span>
      <h3>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h3>
    </header>
    <div class="w3-container" style="padding-bottom:20px;">
      <form id="orderForm" method="post" action="order.php">
        <p>–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞: <strong id="orderTotal"></strong> –≥—Ä–Ω</p>
        <input type="hidden" name="total" id="formTotal">
        <p><input class="w3-input" type="text" name="name" placeholder="–í–∞—à–µ –∏–º—è" required></p>
        <p><input class="w3-input" type="tel" name="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required></p>
        <p>
          <select class="w3-select" name="delivery" required>
            <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ—Å—Ç–∞–≤–∫—É</option>
            <option value="–°–∞–º–æ–≤—ã–≤–æ–∑">–°–∞–º–æ–≤—ã–≤–æ–∑</option>
            <option value="–ê–¥—Ä–µ—Å–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞">–ê–¥—Ä–µ—Å–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</option>
          </select>
        </p>
        <p><textarea class="w3-input" name="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É"></textarea></p>
        <input type="hidden" name="cart" id="formCart">
        <button class="w3-button w3-green" type="submit" style="width:100%">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
      </form>
    </div>
  </div>
</div>

<script>
/* ========= –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ========= */
let startX = 0, startY = 0;
let currentIndex = 1; // 0: search, 1: menu, 2: favorites, 3: cart
const tabs = ["search", "menu", "favorites", "cart"];
let isFromCategoryNav = false;
let isFromTopNav = false;

let menuData = null, cardTemplate = '', sections = [], navLinks = [];
let favorites = new Set(), cart = [], currentProduct = null, quantity = 1;

/* ====== –ú–æ–¥–∞–ª–∫–∏ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–µ—Ç–æ–≤ ====== */
let currentSet = null; // –æ–±—ä–µ–∫—Ç —Å–µ—Ç–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –º–æ–¥–∞–ª–∫–µ
let setModalItems = []; // [{ productId, qty, step, productData }]
let setModalQty = 1;

/* ========= –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è/–¥–∞–Ω–Ω—ã—Ö ========= */
function loadState() {
  try { favorites = new Set(JSON.parse(localStorage.getItem("favorites") || "[]")); } catch { favorites = new Set(); }
  try { cart = JSON.parse(localStorage.getItem("cart") || "[]"); } catch { cart = []; }
}
function saveState() {
  localStorage.setItem("favorites", JSON.stringify([...favorites]));
  localStorage.setItem("cart", JSON.stringify(cart));
}

/* ========= Utility ========= */
function formatPrice(v){ return Number(v||0) + " –≥—Ä–Ω"; }
function findProductById(id){ return menuData.menu.find(x => String(x.id) === String(id)); }

/* ========= –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–≤–∞–π–ø–æ–≤ (–Ω–µ –º–µ–Ω—è–ª) ========= */
document.addEventListener("touchstart", e => {
  startX = e.touches[0].clientX;
  startY = e.touches[0].clientY;
  isFromCategoryNav = e.target.closest("#categoryNav") !== null;
  isFromTopNav = e.target.closest("#topNav") !== null;
});
document.addEventListener("touchend", e => {
  try {
    if (isFromCategoryNav || isFromTopNav) return;
    const dx = e.changedTouches[0].clientX - startX;
    const dy = e.changedTouches[0].clientY - startY;
    if (Math.abs(dx) < 50 || Math.abs(dx) < Math.abs(dy)) return;
    e.preventDefault();
    if (dx < 0) activateTab(currentIndex + 1, "left");
    else activateTab(currentIndex - 1, "right");
  } catch(err) { console.error(err); }
});

/* ========= –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –º–µ–Ω—é –∫ –∞–∫—Ç–∏–≤–Ω–æ–º—É ========= */
function scrollTopNavToActive() {
  const bar = document.getElementById('topNav');
  const active = bar.querySelector('a.active');
  if (!active) return;
  const searchBox = document.getElementById('searchBox');
  const searchWidth = searchBox.offsetWidth || 0;
  const left = active.offsetLeft;
  const right = left + active.offsetWidth;
  const viewLeft = bar.scrollLeft;
  const viewRight = viewLeft + bar.clientWidth;
  const targetLeft = active.textContent.includes('–ú–µ–Ω—é') ? (left - searchWidth) : left;
  if (targetLeft < viewLeft) bar.scrollTo({ left: targetLeft, behavior: 'smooth' });
  else if (right > viewRight) bar.scrollTo({ left: right - bar.clientWidth, behavior: 'smooth' });
}

/* ========= –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∫–ª–∞–¥–∫–∏ (–∫–∞–∫ –±—ã–ª–æ) ========= */
function activateTab(index, direction = "left") {
  if (index < 0 || index >= tabs.length) return;
  currentIndex = index;
  const searchBox = document.getElementById("searchBox");
  const searchInput = document.getElementById("searchInput");
  const topNav = document.getElementById("topNav");
  let savedScroll = topNav.scrollLeft;
  if (searchBox.classList.contains("active") && index !== 0) {
    searchInput.blur();
    searchBox.classList.remove("active");
    searchInput.value = "";
    setTimeout(() => {
      topNav.scrollLeft = savedScroll;
      scrollTopNavToActive();
    }, 310);
  }
  const content = document.getElementById("content");
  content.className = direction === "left" ? "content-left" : "content-right";
  setTimeout(() => {
    const t = tabs[index];
    if (t === "search") {
      showMenu();
      searchBox.classList.add("active");
      setTimeout(() => searchInput.focus(), 200);
    }
    if (t === "menu") showMenu();
    if (t === "favorites") showFavorites();
    if (t === "cart") showCart();
    content.className = "content-active";
    if (t !== "search") scrollTopNavToActive();
  }, 200);
}

/* ========= –°—á—ë—Ç—á–∏–∫–∏ ========= */
function updateFavCount() {
  const el = document.getElementById("favCount");
  if (favorites.size) { el.style.display = "inline-block"; el.textContent = favorites.size; }
  else el.style.display = "none";
  requestAnimationFrame(scrollTopNavToActive);
}
function updateCartCount() {
  const el = document.getElementById("cartCount");
  if (cart.length) { el.style.display = "inline-block"; el.textContent = cart.length; }
  else el.style.display = "none";
  requestAnimationFrame(scrollTopNavToActive);
}

/* ========= –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞ (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è, —Å–ª–µ–≥–∫–∞ —É–ø—Ä–æ—â–µ–Ω–∞) ========= */
function renderCard(item) {
  // item ‚Äî —Ç–æ–≤–∞—Ä –∏–∑ menuData.menu
  const baseVotes = Number(item.vote || 0);
  let html = cardTemplate
    .replace(/{IMAGE}/g, item.images || '')
    .replace(/{NAME}/g, item.name || '')
    .replace(/{PRICE}/g, item.price || '')
    .replace(/{WEIGHT}/g, item.weight || '')
    .replace(/{VOTE}/g, baseVotes);

  const wrap = document.createElement("div");
  wrap.innerHTML = html;
  const card = wrap.firstElementChild;

  const like = card.querySelector(".like-btn");
  const voteEl = card.querySelector(".vote-count");

  const setVoteUI = () => { if (voteEl) voteEl.textContent = String(baseVotes + (favorites.has(item.id) ? 1 : 0)); };
  like.classList.toggle("fas", favorites.has(item.id));
  like.classList.toggle("far", !favorites.has(item.id));
  setVoteUI();

  like.addEventListener("click", (e) => {
    e.stopPropagation();
    if (favorites.has(item.id)) favorites.delete(item.id); else favorites.add(item.id);
    saveState(); updateFavCount();
    like.classList.toggle("fas"); like.classList.toggle("far"); setVoteUI();
  });

  card.addEventListener("click", () => {
    openModal({
      id: item.id,
      name: item.name,
      price: +item.price,
      weight: item.weight,
      image: "images/" + item.images
    });
  });

  return card;
}

/* ========= –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–µ—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—Ç –∂–µ —à–∞–±–ª–æ–Ω card.html, –Ω–æ –º–µ–Ω—è–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ========= */
function renderSetCard(set) {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º cardTemplate, –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª—è –Ω–∞–±–æ—Ä–∞ (images, name, price, weight)
  let html = cardTemplate
    .replace(/{IMAGE}/g, set.images || '')
    .replace(/{NAME}/g, set.name || '')
    .replace(/{PRICE}/g, set.price || '')
    .replace(/{WEIGHT}/g, set.weight || '')
    .replace(/{VOTE}/g, 0);

  const wrap = document.createElement("div");
  wrap.innerHTML = html;
  const card = wrap.firstElementChild;

  const like = card.querySelector(".like-btn");
  const voteEl = card.querySelector(".vote-count");

  const setVoteUI = () => { if (voteEl) voteEl.textContent = String(0 + (favorites.has(set.id) ? 1 : 0)); };
  like.classList.toggle("fas", favorites.has(set.id));
  like.classList.toggle("far", !favorites.has(set.id));
  setVoteUI();

  like.addEventListener("click", (e) => {
    e.stopPropagation();
    if (favorites.has(set.id)) favorites.delete(set.id); else favorites.add(set.id);
    saveState(); updateFavCount();
    like.classList.toggle("fas"); like.classList.toggle("far"); setVoteUI();
    // –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –º—ã –≤ —Ä–∞–∑–¥–µ–ª–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å
    if (currentIndex === 2) showFavorites();
  });

  // –∫–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Å–µ—Ç–∞
  card.addEventListener("click", () => openSetModal(set.id));

  return card;
}

/* ========= –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –Ω–∏–∂–Ω–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (—Ç–æ–≤–∞—Ä—ã) ========= */
function buildMenuNav(cats) {
  const nav = document.getElementById("categoryNav"); nav.innerHTML = '';
  cats.forEach(cat => {
    const a = document.createElement("a"); a.href = "#" + cat.id; a.textContent = cat.name;
    // –ø—Ä–∏ –∫–ª–∏–∫–µ –ø—Ä–æ—Å—Ç–æ –ø–ª–∞–≤–Ω–æ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Å–µ–∫—Ü–∏–∏ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ) ‚Äî –±–µ–∑ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏—è
    a.addEventListener('click', (ev) => { /* –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è —è–∫–æ—Ä–µ–π */ });
    nav.appendChild(a);
  });
  navLinks = nav.querySelectorAll("a");
}

/* ========= –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ (—Ç–æ–≤–∞—Ä—ã) ========= */
function buildCatalog(cats, items) {
  const content = document.getElementById("content"); content.innerHTML = '';
  document.getElementById("categoryNav").style.display = "block";
  cats.forEach(cat => {
    const sec = document.createElement("section"); sec.className = "section"; sec.id = cat.id;
    sec.innerHTML = "<h2>" + cat.name + "</h2>";
    items.filter(i => i.category === cat.id).forEach(item => {
      sec.appendChild(renderCard(item));
    });
    content.appendChild(sec);
  });
  sections = document.querySelectorAll(".section");
  observeSections();
}

function showMenu() { clearFixedBuy(); buildCatalog(menuData.categories, menuData.menu); }

/* ========= –ü–æ–∏—Å–∫ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ========= */
const searchInput = document.getElementById("searchInput");
searchInput.addEventListener("input", () => {
  const query = searchInput.value.toLowerCase();
  if (!query) { showMenu(); return; }
  clearFixedBuy();
  const content = document.getElementById("content");
  content.innerHTML = '<h2 style="margin-top:70px">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h2>';
  document.getElementById("categoryNav").style.display = "none";
  const matches = menuData.menu.filter(i => i.name.toLowerCase().includes(query));
  if (!matches.length) { content.innerHTML += "<p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>"; return; }
  matches.forEach(item => content.appendChild(renderCard(item)));
});

/* ========= –ò–∑–±—Ä–∞–Ω–Ω–æ–µ ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–æ: –≤–∫–ª—é—á–∞–µ—Ç —Ç–æ–≤–∞—Ä—ã –∏ —Å–µ—Ç—ã ========= */
function showFavorites() {
  clearFixedBuy();
  const content = document.getElementById("content");
  content.classList.remove("content-left", "content-right");
  content.innerHTML = '<h2 style="margin-top:70px">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h2>';
  document.getElementById("categoryNav").style.display = "none";

  // –ø—Ä–æ–¥—É–∫—Ç—ã
  const favProducts = menuData.menu.filter(i => favorites.has(i.id));
  // —Å–µ—Ç—ã (–µ—Å–ª–∏ favorites —Å–æ–¥–µ—Ä–∂–∏—Ç id —Å–µ—Ç–∞)
  const favSets = (menuData.sets || []).filter(s => favorites.has(s.id));

  if (!favProducts.length && !favSets.length) { content.innerHTML += "<p>–ü—É—Å—Ç–æ</p>"; return; }

  favSets.forEach(s => content.appendChild(renderSetCard(s)));
  favProducts.forEach(p => content.appendChild(renderCard(p)));
  setTimeout(scrollTopNavToActive,150);
}

/* ========= –ö–æ—Ä–∑–∏–Ω–∞ ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä–æ–¥—É–∫—Ç—ã –∏ —Å–µ—Ç—ã ========= */
function showCart() {
  const content = document.getElementById("content");
  content.classList.remove("content-left", "content-right");
  content.innerHTML = '<h2 style="margin-top:70px">–ö–æ—Ä–∑–∏–Ω–∞</h2>';
  document.getElementById("categoryNav").style.display = "none";
  clearFixedBuy();

  if (!cart.length) { content.innerHTML += "<p>–ü—É—Å—Ç–æ</p>"; return; }

  let total = 0;
  cart.forEach(item => {
    // –ï—Å–ª–∏ —ç—Ç–æ –Ω–∞–±–æ—Ä ‚Äî —É –Ω–µ–≥–æ –ø–æ–ª–µ type === 'set' or item.items exists
    if (item.type === 'set' || item.items) {
      // –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–∞–±–æ—Ä
      const div = document.createElement("div"); div.className = "w3-row basket w3-padding";
      let inner = `<div class="w3-col" style="width:60%"><strong>${item.name}</strong><br><div class="w3-small w3-text-grey">–°–µ—Ç</div>`;
      // –ø–µ—Ä–µ—á–∏—Å–ª–∏–º –≤—Ö–æ–¥—è—â–∏–µ —Ç–æ–≤–∞—Ä—ã (–ø–æ–ª—É—á–∏–º –¥–µ—Ç–∞–ª–∏ –∏–∑ menuData)
      inner += '<div class="w3-margin-top">';
      item.items.forEach(si => {
        const prod = findProductById(si.id);
        const qty = (si.qty || si.quantity || 1) * (item.quantity || 1);
        inner += `<div class="w3-small">${prod ? prod.name : si.id} ‚Äî ${qty} ${prod && prod.unit ? prod.unit : ''} (${prod ? prod.price : si.price} –≥—Ä–Ω)</div>`;
      });
      inner += '</div></div>';

      // –ø—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ ‚Äî –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –Ω–∞–±–æ—Ä–∞
      inner += `<div class="w3-col w3-padding w3-center" style="width:40%"><img src="images/${item.image || ''}" style="width:100%;max-width:200px;"><div class="w3-padding">`;
      inner += `<button class="w3-btn w3-round-xxlarge w3-black" onclick="decQty('${item.id}')">${item.quantity === 1 ? '<i class="fa fa-trash"></i>' : '-'}</button>`;
      inner += `<strong> ${item.quantity} </strong>`;
      inner += `<button class="w3-btn w3-round-xxlarge w3-black" onclick="incQty('${item.id}')">+</button>`;
      inner += `</div></div>`;

      div.innerHTML = inner;
      content.appendChild(div);

      total += (Number(item.price) * (item.quantity || 1));
    } else {
      // –æ–±—ã—á–Ω—ã–π —Ç–æ–≤–∞—Ä ‚Äî –∫–∞–∫ –±—ã–ª–æ
      total += item.price * item.quantity;
      const div = document.createElement("div"); div.className = "w3-row basket w3-padding";
      div.innerHTML = `
        <div class="w3-col" style="width:50%">
          <strong>${item.name}</strong><br>
          <div class="w3-small w3-text-grey">${item.price} –≥—Ä–Ω | ${item.weight || ''}</div>
          <strong>${item.price * item.quantity} –≥—Ä–Ω</strong>
        </div>
        <div class="w3-col w3-padding w3-center" style="width:50%">
          <img src="${item.image}" style="width:100%;max-width:200px;">
          <div class="w3-padding">
            <button class="w3-btn w3-round-xxlarge w3-black" onclick="decQty('${item.id}')">
              ${item.quantity === 1 ? '<i class="fa fa-trash"></i>' : '-'}
            </button>
            <strong> ${item.quantity} </strong>
            <button class="w3-btn w3-round-xxlarge w3-black" onclick="incQty('${item.id}')">+</button>
          </div>
        </div>`;
      content.appendChild(div);
    }
  });

  const bar = document.createElement('div'); bar.className = 'fixed-buy';
  bar.innerHTML = `
    <p class="sum">–ò—Ç–æ–≥–æ: ${total} –≥—Ä–Ω</p>
    <button class="w3-button w3-green w3-round-xxlarge" style="width:100%" onclick="openOrderForm(${total})">–ö—É–ø–∏—Ç—å</button>
  `;
  document.body.appendChild(bar);
  setTimeout(scrollTopNavToActive,150);
}

function clearFixedBuy() { const old = document.querySelector('.fixed-buy'); if (old) old.remove(); }
function incQty(id) {
  const it = cart.find(i => i.id === id);
  if (it) { it.quantity = (it.quantity||0) + 1; saveState(); showCart(); updateCartCount(); }
}
function decQty(id) {
  const i = cart.findIndex(it => it.id === id);
  if (i > -1) {
    if (cart[i].quantity > 1) cart[i].quantity--; else cart.splice(i,1);
  }
  saveState(); showCart(); updateCartCount();
}

/* ========= –ú–æ–¥–∞–ª–∫–∞ —Ç–æ–≤–∞—Ä–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ========= */
function openModal(p) {
  currentProduct = p; quantity = 1;
  document.getElementById("modalName").textContent = p.name;
  document.getElementById("modalPrice").textContent = p.price + " –≥—Ä–Ω";
  document.getElementById("modalWeight").textContent = p.weight || '';
  document.getElementById("modalImage").src = p.image;
  document.getElementById("qtyValue").textContent = 1;
  document.getElementById("totalPrice").textContent = p.price + " –≥—Ä–Ω";
  document.getElementById("productModal").style.display = "block";
}
function closeModal() { document.getElementById("productModal").style.display = "none"; }
document.getElementById("qtyPlus").onclick = () => { quantity++; document.getElementById("qtyValue").textContent = quantity; updateTotal(); }
document.getElementById("qtyMinus").onclick = () => { if (quantity > 1) { quantity--; document.getElementById("qtyValue").textContent = quantity; updateTotal(); } }
function updateTotal() { document.getElementById("totalPrice").textContent = (currentProduct.price * quantity) + " –≥—Ä–Ω"; }
function addToCart() {
  if (!currentProduct) return;
  let ex = cart.find(i => i.id === currentProduct.id && !i.type);
  if (ex) ex.quantity += quantity; else cart.push({ ...currentProduct, quantity, image: currentProduct.image });
  saveState(); updateCartCount(); closeModal();
}
window.onclick = e => {
  if (e.target == document.getElementById("productModal")) closeModal();
  if (e.target == document.getElementById("setModal")) closeSetModal();
  if (e.target == document.getElementById("orderModal")) document.getElementById("orderModal").style.display = 'none';
};

/* ========= –ú–æ–¥–∞–ª–∫–∞ –Ω–∞–±–æ—Ä–∞ ========= */
function openSetModal(setId) {
  const set = (menuData.sets || []).find(s => s.id === setId);
  if (!set) return;
  currentSet = set;
  setModalItems = []; // —Å–±—Ä–æ—Å
  // –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞–±–æ—Ä–∞, –ø–æ–¥—Ç—è–≥–∏–≤–∞—è –¥–∞–Ω–Ω—ã–µ –∏–∑ menuData.menu
  set.items.forEach(pid => {
    const product = findProductById(pid);
    if (!product) return;
    const step = Number(product.step) || 1; // –±–µ—Ä—ë–º —à–∞–≥ –∏–∑ product.step –∏–ª–∏ 1
    const qty = step; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ = —à–∞–≥
    setModalItems.push({ id: product.id, qty, step, product });
  });
  setModalQty = 1;

  // –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –º–æ–¥–∞–ª–∫–∏ DOM
  document.getElementById("setModalName").textContent = set.name;
  document.getElementById("setModalDesc").textContent = set.description || '';
  document.getElementById("setModalImage").src = "images/" + (set.images || '');
  renderSetModalItems();
  updateSetModalTotals();

  document.getElementById("setQtyValue").textContent = setModalQty;
  document.getElementById("setModal").style.display = "block";
}
function closeSetModal() { document.getElementById("setModal").style.display = "none"; currentSet = null; setModalItems = []; }

function renderSetModalItems(){
  const container = document.getElementById("setItemsList");
  container.innerHTML = '';
  setModalItems.forEach((si, idx) => {
    const p = si.product;
    const row = document.createElement('div');
    row.className = 'set-item-row';
    row.innerHTML = `
      <div class="left">
        <img src="images/${p.images || ''}" alt="${p.name}">
        <div>
          <div><strong>${p.name}</strong></div>
          <div class="w3-small w3-text-grey">${p.price} –≥—Ä–Ω | ${p.unit || ''}</div>
        </div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="qty-controls">
          <button class="w3-button w3-round" data-idx="${idx}" data-action="minus">-</button>
          <span id="set_item_qty_${idx}">${si.qty}</span>
          <button class="w3-button w3-round" data-idx="${idx}" data-action="plus">+</button>
        </div>
        <div class="w3-small w3-text-grey" id="set_item_total_${idx}">${(p.price * si.qty)} –≥—Ä–Ω</div>
      </div>
    `;
    container.appendChild(row);
  });

  // –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø–ª—é—Å/–º–∏–Ω—É—Å –≤ –º–æ–¥–∞–ª–∫–µ –Ω–∞–±–æ—Ä–∞ (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏)
  container.querySelectorAll('button[data-action]').forEach(btn=>{
    btn.onclick = (ev) => {
      ev.stopPropagation();
      const idx = Number(btn.getAttribute('data-idx'));
      const action = btn.getAttribute('data-action');
      const item = setModalItems[idx];
      if (!item) return;
      if (action === 'plus') {
        item.qty += item.step;
      } else {
        if (item.qty - item.step >= item.step) item.qty -= item.step;
      }
      document.getElementById(`set_item_qty_${idx}`).textContent = item.qty;
      const totalEl = document.getElementById(`set_item_total_${idx}`);
      totalEl.textContent = (item.product.price * item.qty) + " –≥—Ä–Ω";
      updateSetModalTotals();
    };
  });
}

// —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–∞–º–æ–≥–æ –Ω–∞–±–æ—Ä–∞ (—É–º–Ω–æ–∂–∏—Ç–µ–ª—å)
document.getElementById("setQtyPlus").onclick = () => {
  setModalQty++; document.getElementById("setQtyValue").textContent = setModalQty; updateSetModalTotals();
};
document.getElementById("setQtyMinus").onclick = () => {
  if (setModalQty > 1) setModalQty--; document.getElementById("setQtyValue").textContent = setModalQty; updateSetModalTotals();
};

function updateSetModalTotals() {
  let total = 0;
  setModalItems.forEach(si => total += si.product.price * si.qty);
  total = total * setModalQty;
  document.getElementById("setTotalPrice").textContent = total + " –≥—Ä–Ω";
}

// –∫–Ω–æ–ø–∫–∞ "–¥–æ–±–∞–≤–∏—Ç—å —Å–µ—Ç –≤ –∫–æ—Ä–∑–∏–Ω—É" (–∏–∑ –º–æ–¥–∞–ª–∫–∏)
document.getElementById("addSetToCartBtn").onclick = () => {
  if (!currentSet) return;

  // –ø—Ä–æ–±–µ–≥–∞–µ–º—Å—è –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–æ–≤–∞—Ä—É –≤ –Ω–∞–±–æ—Ä–µ
  setModalItems.forEach(si => {
    // —Å–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç —Ç–æ–≤–∞—Ä–∞ –∫–∞–∫ –µ—Å–ª–∏ –±—ã –æ–Ω –¥–æ–±–∞–≤–ª—è–ª—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
    const cartItem = {
      id: si.id,
      name: si.name,
      price: Number(si.price),
      image: si.image,
      unit: si.unit,
      step: si.step || 1,
      quantity: si.qty * setModalQty, // —É—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–æ—Ä–∞
      fromSet: currentSet.id // –ø–æ–º–µ—Ç–∫–∞, —á—Ç–æ —Ç–æ–≤–∞—Ä –∏–∑ —ç—Ç–æ–≥–æ –Ω–∞–±–æ—Ä–∞
    };

    // –µ—Å–ª–∏ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –∏–∑ —Ç–æ–≥–æ –∂–µ –Ω–∞–±–æ—Ä–∞ —É–∂–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
    const existing = cart.find(c => c.id === cartItem.id && c.fromSet === currentSet.id);
    if (existing) {
      existing.quantity += cartItem.quantity;
    } else {
      cart.push(cartItem);
    }
  });

  saveState();
  updateCartCount();
  closeSetModal();
};


/* ========= –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤–µ—Ä—Ö–Ω–µ–≥–æ –º–µ–Ω—é (–∑–∞–º–µ–Ω–∏–ª –ø—Ä–µ–∂–Ω–∏–π –∏–Ω–¥–µ–∫—Å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫) ========= */
document.getElementById("searchIcon").onclick = () => {
  // –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–∏—Å–∫ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–µ–∂–Ω–∏–π activateTab –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
  activateTab(0,"right");
};

document.getElementById("topNav").addEventListener('click', (e) => {
  const a = e.target.closest('a');
  if (!a) return;
  e.preventDefault();

  // remove active visual from top nav and set on the clicked relevant ones (Menu/Favorites/Cart)
  document.querySelectorAll('#topNav a').forEach(x => x.classList.remove('active'));
  const href = a.getAttribute('href') || '';
  if (href === '#menu' || href === '#favorites' || href === '#cart' || href === '#sets') {
    a.classList.add('active');
  }

  if (href === '#menu') {
    showMenu();
    // rebuild bottom nav for menu categories
    buildMenuNav(menuData.categories);
  } else if (href === '#favorites') {
    showFavorites();
  } else if (href === '#cart') {
    showCart();
  } else if (href === '#sets') {
    // show set categories in bottom nav
    buildSetCategories(menuData.setCategories || []);
    // auto-select first set category if exists
    const cats = menuData.setCategories || [];
    if (cats.length) showSets(cats[0].id);
    else {
      // no categories ‚Äî show all sets
      showSets(null);
    }
  }
});

/* ========= –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–∞–±–æ—Ä–æ–≤ –≤ –Ω–∏–∂–Ω–µ–º –º–µ–Ω—é ========= */
function buildSetCategories(cats) {
  const nav = document.getElementById("categoryNav"); 
  nav.innerHTML = '';

  cats.forEach((cat, index) => {
    const a = document.createElement("a");
    a.href = "#" + cat.id;
    a.textContent = cat.name;

    a.addEventListener('click', (e) => {
      e.preventDefault();
      // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–∏–∂–Ω–µ–≥–æ –º–µ–Ω—é
      document.querySelectorAll('#categoryNav a').forEach(x => x.classList.remove('active'));
      a.classList.add('active');
      showSets(cat.id);
    });

    // üëâ –¥–µ–ª–∞–µ–º –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if (index === 0) {
      a.classList.add('active');
      showSets(cat.id);
    }

    nav.appendChild(a);
  });

  navLinks = nav.querySelectorAll("a");
}


/* ========= –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞–±–æ—Ä–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–∏–ª–∏ –≤—Å–µ—Ö, –µ—Å–ª–∏ categoryId = null) ========= */
function showSets(categoryId) {
  clearFixedBuy();
  const content = document.getElementById("content");
  content.classList.remove("content-left", "content-right");
  content.innerHTML = '<h2 style="margin-top:70px">–ù–∞–±–æ—Ä—ã</h2>';
  document.getElementById("categoryNav").style.display = "block";

  const allSets = menuData.sets || [];
  let filtered = allSets;
  if (categoryId) filtered = allSets.filter(s => s.category === categoryId);

  if (!filtered.length) { content.innerHTML += "<p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>"; return; }

  filtered.forEach(set => {
    // –∫–∞—Ä—Ç–æ—á–∫–∞ –Ω–∞–±–æ—Ä–∞
    content.appendChild(renderSetCard(set));
  });
  setTimeout(scrollTopNavToActive,150);
}

/* ========= –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –∑–∞–≥—Ä—É–∑–∫–∞ menu.json –∏ —à–∞–±–ª–æ–Ω–∞ card.html ========= */
Promise.all([fetch("menu.json").then(r => r.json()), fetch("card.html").then(r => r.text())])
  .then(([data, tpl]) => {
    menuData = data; cardTemplate = tpl;
    loadState();
    // –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–µ–Ω—é –∏ —Å—Ç—Ä–æ–∏–º –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ç–æ–≤–∞—Ä–æ–≤
    buildMenuNav(menuData.categories || []);
    showMenu();
    updateFavCount(); updateCartCount();
  }).catch(err => {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ menu.json –∏–ª–∏ card.html:", err);
    document.getElementById("content").innerHTML = "<p style='padding:20px;color:red'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å menu.json –∏ card.html –≤ —Ç–æ–º –∂–µ –∫–∞—Ç–∞–ª–æ–≥–µ.</p>";
  });

/* ========= –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–∏–∂–Ω–µ–≥–æ –º–µ–Ω—é (observing sections) ========= */
function observeSections() {
  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        navLinks.forEach(l => {
          const active = l.getAttribute("href") === "#" + entry.target.id;
          l.classList.toggle("active", active);
          if (active) l.scrollIntoView({ behavior: "smooth", inline: "center", block: "nearest" });
        });
      }
    });
  }, { threshold: 0.5 });
  sections.forEach(sec => observer.observe(sec));
}

/* ========= –ó–∞–∫–∞–∑ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ========= */
function openOrderForm(total) {
  document.getElementById('orderTotal').textContent = total;
  document.getElementById('formTotal').value = total;
  document.getElementById('formCart').value = JSON.stringify(cart);
  document.getElementById('orderModal').style.display = 'block';
}
</script>

</body>
</html>
